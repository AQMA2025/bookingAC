<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Service AC - Profesional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary-green: #10b981;
        --secondary-green: #059669;
        --accent-orange: #f97316;
        --light-orange: #fed7aa;
        --soft-white: #ffffff;
        --light-gray: #f8fafc;
        --medium-gray: #e2e8f0;
      }

      body {
        font-family: "Poppins", sans-serif;
        background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 25%, #fef7ed 75%, #ffffff 100%);
        min-height: 100vh;
        position: relative;
        overflow-x: hidden;
      }

      /* Animated Background Elements */
      body::before {
        content: '';
        position: fixed;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle at 25% 25%, rgba(16, 185, 129, 0.1) 0%, transparent 50%),
                    radial-gradient(circle at 75% 75%, rgba(249, 115, 22, 0.08) 0%, transparent 50%);
        animation: floating 20s ease-in-out infinite;
        z-index: -1;
      }

      @keyframes floating {
        0%, 100% { transform: translate(0, 0) rotate(0deg); }
        33% { transform: translate(30px, -30px) rotate(120deg); }
        66% { transform: translate(-20px, 20px) rotate(240deg); }
      }

      /* Ice Effects for Header */
      .ice-header {
        position: relative;
        background-attachment: fixed;
      }

      .ice-crystals {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        overflow: hidden;
      }

      .crystal {
        position: absolute;
        color: rgba(255, 255, 255, 0.8);
        font-size: 1.5rem;
        animation: snowfall 8s linear infinite;
        text-shadow: 0 0 10px rgba(173, 216, 230, 0.8);
      }

      .crystal-1 {
        left: 10%;
        animation-delay: 0s;
        animation-duration: 8s;
      }

      .crystal-2 {
        left: 20%;
        animation-delay: 2s;
        animation-duration: 10s;
        font-size: 1.2rem;
      }

      .crystal-3 {
        left: 40%;
        animation-delay: 4s;
        animation-duration: 12s;
      }

      .crystal-4 {
        left: 60%;
        animation-delay: 1s;
        animation-duration: 9s;
        font-size: 1.8rem;
      }

      .crystal-5 {
        left: 80%;
        animation-delay: 3s;
        animation-duration: 11s;
      }

      .crystal-6 {
        left: 90%;
        animation-delay: 5s;
        animation-duration: 7s;
        font-size: 1.3rem;
      }

      @keyframes snowfall {
        0% {
          transform: translateY(-100px) rotate(0deg);
          opacity: 0;
        }
        10% {
          opacity: 1;
        }
        90% {
          opacity: 1;
        }
        100% {
          transform: translateY(200px) rotate(360deg);
          opacity: 0;
        }
      }

      /* Frost effect on header text */
      .ice-header h1 {
        text-shadow: 0 0 20px rgba(173, 216, 230, 0.8), 0 0 40px rgba(135, 206, 250, 0.6);
        position: relative;
        z-index: 10;
      }

      /* Cool breath effect */
      .ice-header::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 30px;
        background: linear-gradient(to top, rgba(173, 216, 230, 0.3), transparent);
        animation: breathe 3s ease-in-out infinite;
      }

      @keyframes breathe {
        0%, 100% { opacity: 0.3; }
        50% { opacity: 0.7; }
      }

      /* Service section styles */
      .service-section {
        background: linear-gradient(135deg, #ffffff, #f8fafc);
        border: 2px solid #e2e8f0;
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 16px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      }

      .service-section:hover {
        border-color: var(--primary-green);
        box-shadow: 0 8px 24px rgba(16, 185, 129, 0.15);
        transform: translateY(-2px);
      }

      .service-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
      }

      .service-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #374151;
      }

      .unit-counter {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 500;
      }

      .quantity-controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 16px;
      }

      .quantity-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 2px solid #e5e7eb;
        background: #ffffff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        font-weight: 600;
        color: #374151;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .quantity-btn:hover:not(.disabled) {
        border-color: var(--primary-green);
        color: var(--primary-green);
        transform: scale(1.05);
      }

      .quantity-btn.disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }

      .quantity-display {
        font-size: 2rem;
        font-weight: 700;
        color: #374151;
        min-width: 60px;
        text-align: center;
      }

      /* Price list styles */
      .price-list-toggle {
        transition: all 0.3s ease;
        background: linear-gradient(135deg, var(--soft-white), var(--light-gray));
        border: 2px solid var(--medium-gray);
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .price-list-toggle:hover {
        border-color: var(--primary-green);
        box-shadow: 0 4px 16px rgba(16, 185, 129, 0.2);
        transform: translateY(-2px);
      }

      .price-list-content {
        animation: slideDown 0.3s ease-out;
        background: var(--soft-white);
        border-radius: 12px;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Form styling */
      .form-input {
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 12px 16px;
        transition: all 0.2s ease;
        background: #ffffff;
      }

      .form-input:focus {
        border-color: var(--primary-green);
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        outline: none;
      }

      /* Time slot styling */
      .time-slot {
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        padding: 16px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
        background: #ffffff;
      }

      .time-slot:hover {
        border-color: var(--primary-green);
        background: #f0fdf4;
      }

      .time-slot.selected {
        border-color: var(--primary-green);
        background: var(--primary-green);
        color: white;
      }

      /* Submit button */
      .submit-btn {
        background: linear-gradient(135deg, var(--primary-green), var(--secondary-green));
        border: none;
        border-radius: 12px;
        padding: 16px 32px;
        color: white;
        font-weight: 600;
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
      }

      .submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
      }

      .submit-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      /* Mobile Responsive Improvements */
      @media (max-width: 768px) {
        .container {
          padding: 0.25rem;
          max-width: 100%;
        }
        
        .ice-header {
          padding: 1.5rem 1rem;
          min-height: 160px;
        }
        
        .ice-header h1 {
          font-size: 1.5rem;
          margin-bottom: 0.5rem;
        }
        
        .ice-header .w-24.h-24 {
          width: 4rem;
          height: 4rem;
          margin-bottom: 1rem;
        }
        
        .ice-header .w-20.h-20 {
          width: 3.5rem;
          height: 3.5rem;
        }
        
        .bg-white.rounded-b-lg.shadow-xl {
          margin: 0;
          padding: 1rem;
        }
        
        .form-input {
          padding: 0.875rem;
          font-size: 1rem;
        }
        
        .form-group label {
          font-size: 0.875rem;
          margin-bottom: 0.5rem;
        }
        
        .service-card {
          padding: 1rem;
          margin-bottom: 1rem;
        }
        
        .service-card h3 {
          font-size: 1.125rem;
        }
        
        .price-display {
          font-size: 0.875rem;
        }
        
        .quantity-controls button {
          width: 2.5rem;
          height: 2.5rem;
          font-size: 1.25rem;
        }
        
        .time-slot {
          padding: 0.75rem;
          font-size: 0.875rem;
        }
        
        .submit-button {
          padding: 1rem;
          font-size: 1rem;
          font-weight: 600;
        }
        
        /* Modal responsive */
        .modal-content {
          margin: 1rem;
          padding: 1.5rem;
          max-width: calc(100vw - 2rem);
        }
        
        /* Quota status responsive */
        #quotaStatus {
          padding: 0.75rem;
          font-size: 0.875rem;
          margin: 0.5rem;
        }
        
        /* Price list responsive */
        .price-list-content {
          padding: 1rem;
        }
        
        .price-item {
          padding: 0.75rem;
          font-size: 0.875rem;
        }
      }
      
      /* Tablet responsive */
      @media (min-width: 769px) and (max-width: 1024px) {
        .container {
          max-width: 90%;
          padding: 1.5rem;
        }
        
        .ice-header {
          padding: 3rem 2rem;
        }
        
        .bg-white.rounded-lg.shadow-xl {
          padding: 2rem;
        }
      }

      /* Enhanced form styling */
      .form-input {
        border: 2px solid var(--medium-gray);
        border-radius: 0.75rem;
        padding: 1rem;
        transition: all 0.3s ease;
        background-color: var(--soft-white);
      }
      
      .form-input:focus {
        border-color: var(--primary-green);
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        outline: none;
      }
      
      .form-input:disabled,
      .form-input[readonly] {
        background-color: var(--light-gray);
        border-color: var(--medium-gray);
        color: #6b7280;
      }

      /* Service card improvements */
      .service-card {
        border: 2px solid var(--medium-gray);
        border-radius: 1rem;
        padding: 1.5rem;
        transition: all 0.3s ease;
        background: linear-gradient(135deg, var(--soft-white) 0%, #fafafa 100%);
      }
      
      .service-card:hover {
        border-color: var(--primary-green);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.15);
      }

      /* Button improvements */
      .quantity-controls button {
        border-radius: 0.5rem;
        font-weight: 600;
        transition: all 0.2s ease;
      }
      
      .quantity-controls button:hover {
        transform: scale(1.05);
      }
      
      .time-slot {
        border: 2px solid var(--medium-gray);
        border-radius: 0.75rem;
        padding: 1rem;
        transition: all 0.3s ease;
        cursor: pointer;
        background: var(--soft-white);
      }
      
      .time-slot:hover {
        border-color: var(--primary-green);
        background-color: rgba(16, 185, 129, 0.05);
      }
      
      .time-slot.selected {
        border-color: var(--primary-green);
        background-color: var(--primary-green);
        color: white;
      }

      /* Submit button enhancement */
      .submit-button {
        background: linear-gradient(135deg, var(--primary-green) 0%, var(--secondary-green) 100%);
        border-radius: 0.75rem;
        padding: 1rem 2rem;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
      }
      
      .submit-button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
      }
      
      .submit-button:disabled {
        background: var(--medium-gray);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
    </style>
</head>
<body>
    <!-- Background decorative circles -->
    <div class="bg-decoration bg-circle-1"></div>
    <div class="bg-decoration bg-circle-2"></div>
    <div class="bg-decoration bg-circle-3"></div>

    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header with Pinterest Background -->
        <div
          class="header text-white p-8 text-center relative overflow-hidden ice-header rounded-t-lg shadow-xl"
          style="background: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('https://images.unsplash.com/photo-1609707042324-730abfaee452?q=80&w=1170&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D') center/cover; opacity: 0.7;"
        >
          <!-- Ice crystals animation -->
          <div class="ice-crystals">
            <div class="crystal crystal-1">❄️</div>
            <div class="crystal crystal-2">❅</div>
            <div class="crystal crystal-3">❄️</div>
            <div class="crystal crystal-4">❅</div>
            <div class="crystal crystal-5">❄️</div>
            <div class="crystal crystal-6">❅</div>
            <div class="crystal crystal-5">❅</div>
            <div class="crystal crystal-6">❆</div>
          </div>

          <div class="relative z-10">
            <div class="w-24 h-24 bg-white rounded-full mx-auto mb-4 flex items-center justify-content shadow-lg">
              <img src="https://i.pinimg.com/736x/10/1e/a6/101ea6b3464455757657e2fccaad69c8.jpg" alt="AFC Logo" class="w-20 h-20 mx-auto rounded-full" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
              <div class="w-20 h-20 bg-green-600 rounded-full mx-auto flex items-center justify-center" style="display:none;">
                <span class="text-white font-bold text-xl">AFC</span>
              </div>
            </div>
            <h1 class="text-3xl font-bold mb-2">Booking Layanan AC</h1>
          </div>
        </div>

        <!-- Main Content -->
        <div class="bg-white rounded-b-lg shadow-xl p-8 -mt-1">
            <!-- Quota Status -->
            <div id="quotaStatus" class="mb-6 p-4 bg-gradient-to-r from-green-50 to-blue-50 border-2 border-green-200 rounded-xl shadow-sm text-center">
                <p class="text-gray-600">Memuat informasi kuota...</p>
            </div>

            <!-- Booking Form -->
            <form id="bookingForm" class="space-y-6">
                <!-- Booking ID -->
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Booking ID</label>
                    <input type="text" id="bookingId" readonly class="form-input w-full bg-gray-50 text-gray-600 cursor-not-allowed">
                </div>

                <!-- Nama Lengkap -->
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap <span class="text-red-500">*</span></label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-green-500">👤</span>
                        <input type="text" id="nama" required class="form-input w-full pl-10" placeholder="Masukan nama Anda">
                    </div>
                </div>

                <!-- No WhatsApp -->
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-2">No WhatsApp <span class="text-red-500">*</span></label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-green-500">📱</span>
                        <input type="tel" id="noHp" required class="form-input w-full pl-10" placeholder="awali dengan angka 62 ( contoh : 62812XXXXXXX)">
                    </div>
                </div>

                <!-- Alamat Lengkap -->
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Alamat Lengkap <span class="text-red-500">*</span></label>
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-green-500">📍</span>
                        <textarea id="alamat" required class="form-input w-full pl-10 h-20" placeholder="Contoh : D4/13 atau alamat lengkap jika eksternal"></textarea>
                    </div>
                </div>

                <!-- Tanggal Kunjungan -->
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Kunjungan <span class="text-red-500">*</span></label>
                    <input type="date" id="tanggalKunjungan" required class="form-input w-full">
                    <div class="mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded text-sm text-yellow-700">
                        ⚠️ Wajib pilih tanggal untuk melihat slot tersedia
                    </div>
                </div>

                <!-- Daftar Harga Section -->
                <div class="form-group">
                    <div id="priceListToggle" class="cursor-pointer bg-blue-50 border border-blue-200 rounded-lg p-4 text-center hover:bg-blue-100 transition price-list-toggle">
                        <span class="text-blue-700 font-medium">📋 Klik disini untuk melihat daftar harga</span>
                    </div>

                    <div id="priceListContent" class="hidden mt-4 bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm price-list-content">
                        <div class="bg-gray-50 p-3 border-b">
                            <h3 class="font-semibold text-gray-800">💰 Daftar Harga Layanan AC</h3>
                        </div>
                        <div class="p-4">
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between py-2 border-b border-gray-100">
                                    <span class="text-gray-700">Cuci</span>
                                    <span class="font-medium text-blue-600">Rp 80.000</span>
                                </div>
                                <div class="flex justify-between py-2 border-b border-gray-100">
                                    <span class="text-gray-700">Bobok Dinding/titik</span>
                                    <span class="font-medium text-gray-800">Rp 100.000</span>
                                </div>
                                <div class="flex justify-between py-2 border-b border-gray-100">
                                    <span class="text-gray-700">AC Multi/Unit Indoor</span>
                                    <span class="font-medium text-gray-800">Rp 150.000</span>
                                </div>
                                <div class="flex justify-between py-2 border-b border-gray-100">
                                    <span class="text-gray-700">Perbaikan Minor</span>
                                    <span class="font-medium text-gray-800">Rp 150.000</span>
                                </div>
                                <div class="flex justify-between py-2 border-b border-gray-100">
                                    <span class="text-gray-700">Bobok Dinding/m'</span>
                                    <span class="font-medium text-gray-800">Rp 150.000</span>
                                </div>
                                <div class="flex justify-between py-2 border-b border-gray-100">
                                    <span class="text-gray-700">Bongkar Unit</span>
                                    <span class="font-medium text-gray-800">Rp 200.000</span>
                                </div>
                                <div class="flex justify-between py-2 border-b border-gray-100">
                                    <span class="text-gray-700">Pasang Unit</span>
                                    <span class="font-medium text-orange-600">Rp 350.000</span>
                                </div>
                                <div class="flex justify-between py-2 border-b border-gray-100">
                                    <span class="text-gray-700">Perbaikan Mayor</span>
                                    <span class="font-medium text-red-600">Rp 400.000</span>
                                </div>
                                <div class="flex justify-between py-2 border-b border-gray-100">
                                    <span class="text-gray-700">Isi Freon</span>
                                    <span class="font-medium text-red-600">Rp 400.000</span>
                                </div>
                                <div class="flex justify-between py-2 border-b border-gray-100">
                                    <span class="text-gray-700">Bongkar & Pasang</span>
                                    <span class="font-medium text-red-600">Rp 450.000</span>
                                </div>
                                <div class="flex justify-between py-2">
                                    <span class="text-gray-700">Overhoul/Cuci Besar</span>
                                    <span class="font-medium text-red-700">Rp 465.000</span>
                                </div>
                            </div>
                            <div class="mt-3 pt-3 border-t border-gray-200">
                                <p class="text-xs text-gray-500 text-center">💡 Harga dapat berubah sesuai kondisi lapangan</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Service Selection -->
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-4">Pilih Layanan <span class="text-red-500">*</span></label>
                    <p class="text-xs text-gray-600 mb-4">💡 Total maksimal 15 unit AC per hari (gabungan cuci + perbaikan)</p>

                    <!-- Cek / Cuci Unit -->
                    <div class="service-section">
                        <div class="service-header">
                            <h3 class="service-title">🧽 Cek / Cuci Unit</h3>
                            <span id="cuciCount" class="unit-counter bg-blue-100 text-blue-800">0 unit</span>
                        </div>
                        <div class="quantity-controls">
                            <button type="button" class="quantity-btn disabled" id="cuciMinus">−</button>
                            <div class="quantity-display" id="cuciQuantity">0</div>
                            <button type="button" class="quantity-btn" id="cuciPlus">+</button>
                        </div>
                    </div>

                    <!-- Perbaikan Unit -->
                    <div class="service-section">
                        <div class="service-header">
                            <h3 class="service-title">🔧 Perbaikan Unit</h3>
                            <span id="perbaikanCount" class="unit-counter bg-green-100 text-green-800">0 unit</span>
                        </div>
                        <div class="quantity-controls">
                            <button type="button" class="quantity-btn disabled" id="perbaikanMinus">−</button>
                            <div class="quantity-display" id="perbaikanQuantity">0</div>
                            <button type="button" class="quantity-btn" id="perbaikanPlus">+</button>
                        </div>
                    </div>

                    <!-- Pasang Unit Baru -->
                    <div class="service-section" style="border: 2px solid #10b981;">
                        <div class="service-header">
                            <h3 class="service-title">🏠 Pasang Unit Baru</h3>
                            <span id="pasangCount" class="unit-counter bg-purple-100 text-purple-800">0 unit</span>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-lg mb-4">
                            <p class="text-sm text-blue-700">📋 Informasi Pemasangan Unit Baru:</p>
                            <p class="text-xs text-blue-600 mt-1">Untuk pemasangan unit baru, teknisi kami akan melakukan survei lokasi untuk menentukan kebutuhan panjang pipa, kabel dan material lainnya sebelum dilakukan pemasangan unit.</p>
                        </div>
                        <div class="quantity-controls">
                            <button type="button" class="quantity-btn disabled" id="pasangMinus">−</button>
                            <div class="quantity-display" id="pasangQuantity">0</div>
                            <button type="button" class="quantity-btn" id="pasangPlus">+</button>
                        </div>
                    </div>

                    <!-- Total Unit AC -->
                    <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                        <div class="flex justify-between items-center">
                            <span class="font-medium text-gray-700">Total Unit AC:</span>
                            <span id="totalUnits" class="text-xl font-bold text-gray-900">0 / 15</span>
                        </div>
                    </div>
                </div>

                <!-- Pilih Waktu Kunjungan -->
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-4">Pilih Waktu Kunjungan <span class="text-red-500">*</span></label>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="time-slot" id="morningSlot">
                            <div class="text-2xl mb-2">🌅</div>
                            <div class="font-semibold">Pagi</div>
                            <div class="text-sm text-gray-600">09:00 - 11:30</div>
                        </div>
                        <div class="time-slot" id="afternoonSlot">
                            <div class="text-2xl mb-2">☀️</div>
                            <div class="font-semibold">Siang</div>
                            <div class="text-sm text-gray-600">13:00 - 16:00</div>
                        </div>
                    </div>
                    <input type="hidden" id="waktuKunjungan" name="waktuKunjungan" required>
                </div>

                <!-- Catatan Khusus -->
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Catatan Khusus (Opsional)</label>
                    <textarea id="catatan" class="form-input w-full h-20" placeholder="Contoh : Saya bersedia reschedule kunjungan teknisi jika ada jadwal kosong lebih cepat"></textarea>
                </div>

                <!-- Kode Referral -->
                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Kode Referral (Opsional)</label>
                    <input type="text" id="kodeReferral" class="form-input w-full" placeholder="MASUKKAN KODE REFERRAL JIKA ADA">
                    <p class="text-xs text-gray-500 mt-1">Kode referral akan otomatis terisi jika Anda mengakses melalui link referral</p>
                </div>

                <!-- Submit Button -->
                <button type="submit" class="submit-btn w-full">
                    Pilih Minimal 1 Layanan
                </button>
            </form>
        </div>
    </div>

    <!-- Modals -->
    <!-- Loading Modal -->
    <div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-8 text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-600 mx-auto mb-4"></div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Memproses Booking</h3>
            <p class="text-gray-600">Mohon tunggu sebentar...</p>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-8 text-center max-w-md mx-4">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <span class="text-green-600 text-2xl">✅</span>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Booking Berhasil!</h3>
            <p class="text-gray-600 mb-4">Booking Anda telah berhasil disimpan dan notifikasi WhatsApp akan segera dikirim.</p>
            <button onclick="closeSuccessModal()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">OK</button>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-8 text-center max-w-md mx-4">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <span class="text-red-600 text-2xl">❌</span>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Terjadi Kesalahan</h3>
            <p id="errorMessage" class="text-gray-600 mb-4">Silakan coba lagi</p>
            <button onclick="closeErrorModal()" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700">OK</button>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://xjzrrxmrgxuebimvkxhp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqenJyeG1yZ3h1ZWJpbXZreGhwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MTUwODIsImV4cCI6MjA3MTE5MTA4Mn0.ntXRlLylqiJfA5NbGet1h0977CXPHVCE_G-9OM5R0Wg';
        
        // Initialize Supabase client
        let supabaseClient = null;
        try {
            if (typeof supabase !== 'undefined' && supabase.createClient) {
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('Supabase client initialized successfully');
            } else {
                console.warn('Supabase library not loaded, using fallback mode');
            }
        } catch (error) {
            console.error('Failed to initialize Supabase client:', error);
        }

        // DOM Elements
        const bookingForm = document.getElementById('bookingForm');
        const bookingIdInput = document.getElementById('bookingId');
        const quotaStatus = document.getElementById('quotaStatus');
        const loadingModal = document.getElementById('loadingModal');
        const successModal = document.getElementById('successModal');
        const errorModal = document.getElementById('errorModal');
        const errorMessage = document.getElementById('errorMessage');

        // Service quantities
        let serviceQuantities = {
            cuci: 0,
            perbaikan: 0,
            pasang: 0
        };

        // Indonesian National Holidays 2025 & 2026
        const nationalHolidays = {
            // 2025 - Official Government List
            '2025-01-01': 'Tahun Baru Masehi',
            '2025-01-27': 'Isra Miraj Nabi Muhammad SAW',
            '2025-01-29': 'Tahun Baru Imlek 2576 Kongzili',
            '2025-03-29': 'Hari Raya Nyepi Tahun Baru Saka 1947',
            '2025-03-31': 'Hari Raya Idul Fitri 1446 Hijriah',
            '2025-04-01': 'Hari Raya Idul Fitri 1446 Hijriah',
            '2025-04-18': 'Wafat Yesus Kristus',
            '2025-04-20': 'Kebangkitan Yesus Kristus (Paskah)',
            '2025-05-01': 'Hari Buruh Internasional',
            '2025-05-12': 'Hari Raya Waisak 2569 BE',
            '2025-05-29': 'Kenaikan Yesus Kristus',
            '2025-06-01': 'Hari Lahir Pancasila',
            '2025-06-06': 'Hari Raya Idul Adha 1446 Hijriah',
            '2025-08-17': 'Hari Kemerdekaan Republik Indonesia',
            '2025-09-05': 'Maulid Nabi Muhammad SAW',
            '2025-12-25': 'Hari Raya Natal',
            
            // 2026 - Based on Official Calendar
            '2026-01-01': 'Tahun Baru 2026 Masehi',
            '2026-01-16': 'Isra Mikraj Nabi Muhammad SAW',
            '2026-02-17': 'Tahun Baru Imlek 2577 Kongzili',
            '2026-02-19': 'Awal Puasa Ramadhan 1447 Hijriyah',
            '2026-03-19': 'Hari Suci Nyepi Tahun Baru Saka 1948',
            '2026-03-21': 'Hari Raya Idul Fitri 1447 Hijriyah',
            '2026-03-22': 'Hari Raya Idul Fitri 1447 Hijriyah',
            '2026-04-03': 'Wafat Yesus Kristus',
            '2026-04-05': 'Hari Paskah',
            '2026-05-01': 'Hari Buruh Internasional',
            '2026-05-14': 'Kenaikan Yesus Kristus',
            '2026-05-27': 'Hari Raya Idul Adha 1447 Hijriyah',
            '2026-05-31': 'Hari Raya Waisak 2570 BE',
            '2026-06-01': 'Hari Lahir Pancasila',
            '2026-06-16': 'Tahun Baru Islam 1448 Hijriyah',
            '2026-08-17': 'Hari Kemerdekaan Indonesia',
            '2026-08-25': 'Maulid Nabi Muhammad SAW',
            '2026-12-25': 'Hari Raya Natal'
        };

        // Initialize booking ID on page load
        async function initializeBookingId() {
            try {
                let nextBookingId = 'AFC-202501';
                
                if (supabaseClient) {
                    const { data: latestBooking, error } = await supabaseClient
                        .from('bookings')
                        .select('booking_id')
                        .like('booking_id', 'AFC-%')
                        .order('booking_id', { ascending: false })
                        .limit(1);
                    
                    if (error) {
                        console.error('Database query error:', error);
                    } else if (latestBooking && latestBooking.length > 0) {
                        const lastId = latestBooking[0].booking_id;
                        console.log('Latest booking ID from database:', lastId);
                        const lastNumber = parseInt(lastId.replace('AFC-', ''));
                        if (!isNaN(lastNumber)) {
                            // Always increment from the highest booking ID found
                            nextBookingId = `AFC-${String(lastNumber + 1).padStart(6, '0')}`;
                            console.log('Calculated next booking ID:', nextBookingId);
                        } else {
                            console.log('Using default starting ID (invalid last number)');
                        }
                    } else {
                        console.log('No existing bookings found, using default starting ID');
                    }
                }
                
                bookingIdInput.value = nextBookingId;
                bookingIdInput.dispatchEvent(new Event('input', { bubbles: true }));
                console.log('Booking ID initialized:', nextBookingId);
                
            } catch (error) {
                console.error('Error initializing booking ID:', error);
                bookingIdInput.value = 'AFC-202501';
                bookingIdInput.dispatchEvent(new Event('input', { bubbles: true }));
            }
        }

        // Fetch daily quota
        async function fetchDailyQuota() {
            try {
                const today = new Date().toISOString().split('T')[0];
                
                if (supabaseClient) {
                    const { data: bookings } = await supabaseClient
                        .from('bookings')
                        .select('jumlah_unit')
                        .eq('tanggal_kunjungan', today);
                    
                    const totalBooked = bookings ? bookings.reduce((sum, booking) => sum + (booking.jumlah_unit || 0), 0) : 0;
                    const maxCapacity = 15;
                    const available = Math.max(0, maxCapacity - totalBooked);
                    
                    quotaStatus.innerHTML = `
                        <div class="text-center">
                            <p class="text-lg font-semibold">Kuota unit terjadwal pada ${new Date().toLocaleDateString('id-ID', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})}</p>
                            <p class="text-sm ${available > 0 ? 'text-green-600' : 'text-red-600'}">
                                ${available > 0 ? `✅ Tersedia ${available} slot` : '❌ Kuota penuh'}
                            </p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error fetching quota:', error);
                quotaStatus.innerHTML = '<p class="text-gray-600">Tidak dapat memuat kuota</p>';
            }
        }

        // Price list toggle functionality
        const priceListToggle = document.getElementById("priceListToggle");
        const priceListContent = document.getElementById("priceListContent");

        priceListToggle.addEventListener("click", function () {
            const isHidden = priceListContent.classList.contains("hidden");

            if (isHidden) {
                priceListContent.classList.remove("hidden");
                priceListToggle.innerHTML =
                    '<span class="text-blue-700 font-medium">📋 Tutup daftar harga</span>';
                priceListToggle.classList.add("bg-blue-100");
            } else {
                priceListContent.classList.add("hidden");
                priceListToggle.innerHTML =
                    '<span class="text-blue-700 font-medium">📋 Klik disini untuk melihat daftar harga</span>';
                priceListToggle.classList.remove("bg-blue-100");
            }
        });

        // Date validation
        const tanggalKunjunganInput = document.getElementById('tanggalKunjungan');
        
        // Set minimum date to today
        const today = new Date();
        const todayString = today.toISOString().split('T')[0];
        tanggalKunjunganInput.min = todayString;
        
        tanggalKunjunganInput.addEventListener("input", function (e) {
            const selectedDateString = e.target.value;
            const selectedDate = new Date(selectedDateString + "T00:00:00");
            const currentDate = new Date();
            currentDate.setHours(0, 0, 0, 0);
            
            // Block past dates
            if (selectedDate < currentDate) {
                alert('Tidak dapat memilih tanggal yang sudah lewat. Silakan pilih tanggal hari ini atau yang akan datang.');
                e.target.value = "";
                return;
            }

            // Check for Sunday in 2025 and 2026
            if (selectedDateString.startsWith("2025") || selectedDateString.startsWith("2026")) {
                const selectedDate = new Date(selectedDateString + "T00:00:00");
                if (selectedDate.getDay() === 0) {
                    // Sunday
                    const year = selectedDateString.substring(0, 4);
                    alert(
                        `Mohon maaf, kami tidak melayani booking pada hari Minggu di tahun ${year}. Silakan pilih hari lain.`
                    );
                    e.target.value = "";
                    return;
                }
            }

            // Check for national holidays
            if (nationalHolidays[selectedDateString]) {
                const holidayName = nationalHolidays[selectedDateString];
                alert(
                    `Mohon maaf, kami tidak melayani booking pada tanggal merah (${holidayName}). Silakan pilih hari lain.`
                );
                e.target.value = "";
                return;
            }
        });

        // Service quantity management
        function updateQuantity(serviceType, change) {
            const currentQty = serviceQuantities[serviceType];
            const totalOtherServices = Object.keys(serviceQuantities)
                .filter(key => key !== serviceType)
                .reduce((sum, key) => sum + serviceQuantities[key], 0);

            let newQty = currentQty + change;

            // Ensure quantity doesn't go below 0
            if (newQty < 0) newQty = 0;

            // Check if total would exceed 15
            if (totalOtherServices + newQty > 15) {
                alert('Total maksimal 15 unit AC per hari');
                return;
            }

            serviceQuantities[serviceType] = newQty;
            updateServiceDisplay();
            updateSubmitButton();
        }

        function updateServiceDisplay() {
            // Update cuci
            document.getElementById('cuciQuantity').textContent = serviceQuantities.cuci;
            document.getElementById('cuciCount').textContent = `${serviceQuantities.cuci} unit`;
            document.getElementById('cuciMinus').classList.toggle('disabled', serviceQuantities.cuci === 0);

            // Update perbaikan
            document.getElementById('perbaikanQuantity').textContent = serviceQuantities.perbaikan;
            document.getElementById('perbaikanCount').textContent = `${serviceQuantities.perbaikan} unit`;
            document.getElementById('perbaikanMinus').classList.toggle('disabled', serviceQuantities.perbaikan === 0);

            // Update pasang
            document.getElementById('pasangQuantity').textContent = serviceQuantities.pasang;
            document.getElementById('pasangCount').textContent = `${serviceQuantities.pasang} unit`;
            document.getElementById('pasangMinus').classList.toggle('disabled', serviceQuantities.pasang === 0);

            // Update total
            const total = Object.values(serviceQuantities).reduce((sum, qty) => sum + qty, 0);
            document.getElementById('totalUnits').textContent = `${total} / 15`;

            // Disable plus buttons if total would exceed 15
            const canAdd = total < 15;
            document.getElementById('cuciPlus').classList.toggle('disabled', !canAdd);
            document.getElementById('perbaikanPlus').classList.toggle('disabled', !canAdd);
            document.getElementById('pasangPlus').classList.toggle('disabled', !canAdd);
        }

        function updateSubmitButton() {
            const total = Object.values(serviceQuantities).reduce((sum, qty) => sum + qty, 0);
            const submitBtn = document.querySelector('button[type="submit"]');
            
            if (total > 0) {
                submitBtn.textContent = `Booking ${total} Unit AC`;
                submitBtn.disabled = false;
            } else {
                submitBtn.textContent = 'Pilih Minimal 1 Layanan';
                submitBtn.disabled = true;
            }
        }

        // Service button event listeners
        document.getElementById('cuciPlus').addEventListener('click', () => updateQuantity('cuci', 1));
        document.getElementById('cuciMinus').addEventListener('click', () => updateQuantity('cuci', -1));
        document.getElementById('perbaikanPlus').addEventListener('click', () => updateQuantity('perbaikan', 1));
        document.getElementById('perbaikanMinus').addEventListener('click', () => updateQuantity('perbaikan', -1));
        document.getElementById('pasangPlus').addEventListener('click', () => updateQuantity('pasang', 1));
        document.getElementById('pasangMinus').addEventListener('click', () => updateQuantity('pasang', -1));

        // Time slot selection
        const morningSlot = document.getElementById('morningSlot');
        const afternoonSlot = document.getElementById('afternoonSlot');
        const waktuKunjunganInput = document.getElementById('waktuKunjungan');

        function selectTimeSlot(selectedSlot) {
            // Remove selected class from all slots
            morningSlot.classList.remove('selected');
            afternoonSlot.classList.remove('selected');
            
            // Add selected class to clicked slot
            selectedSlot.classList.add('selected');
            
            // Set hidden input value
            if (selectedSlot === morningSlot) {
                waktuKunjunganInput.value = 'morning';
            } else {
                waktuKunjunganInput.value = 'afternoon';
            }
        }

        morningSlot.addEventListener('click', () => selectTimeSlot(morningSlot));
        afternoonSlot.addEventListener('click', () => selectTimeSlot(afternoonSlot));

        // WhatsApp message function
        async function sendWhatsAppNotification(
            customerName,
            customerPhone,
            visitDate,
            address,
            bookingId,
            serviceDetails,
            notes,
            unitCount,
            waktuText
        ) {
            try {
                // Format phone number
                let formattedPhone = customerPhone.toString().replace(/\D/g, '');
                if (formattedPhone.startsWith('0')) {
                    formattedPhone = '62' + formattedPhone.substring(1);
                } else if (!formattedPhone.startsWith('62')) {
                    formattedPhone = '62' + formattedPhone;
                }

                const formattedDate = new Date(visitDate).toLocaleDateString('id-ID', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                const notesInfo = notes ? `\n\n*Catatan:*\n_${notes}_` : "";

                const customerMessage = `📋 *KONFIRMASI BOOKING SERVICE AC*

*Booking ID: ${bookingId}*

Halo Bpk/Ibu *${customerName}*! 👋 

Booking layanan AC Anda telah berhasil dicatat:

📅 *Tanggal Kunjungan:* ${formattedDate}
🏠 *Alamat:* ${address}

🛠️ *Detail Layanan:*
${serviceDetails}
*Waktu:* ${waktuText}

*Total Unit AC: ${unitCount} unit*${notesInfo}

✅ Teknisi kami akan melakukan kunjungan sesuai jadwal di atas.

Jika ada pertanyaan atau perlu mengubah jadwal, silakan hubungi kami.

*AQSHA FRESH & COOL*
_Layanan AC Profesional De Latinos & Sekitarnya_`;

                const response = await fetch("https://crm.woo-wa.com/send/message-text", {
                    method: "POST",
                    headers: { 
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        deviceId: "d_ID@6753a3309becd_ZxDLjmEkpsiWQ",
                        number: formattedPhone,
                        message: customerMessage,
                    }),
                });

                console.log("WhatsApp API Response:", response.status);
                
                if (response.ok) {
                    console.log("✅ WhatsApp message sent successfully");
                } else {
                    console.error("❌ WhatsApp API failed:", await response.text());
                }
                
                return response.ok;

            } catch (error) {
                console.error("Error sending WhatsApp:", error);
                return false;
            }
        }

        // Form submission handler
        bookingForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                // Show loading
                loadingModal.classList.remove('hidden');
                
                // Validate booking ID format
                const bookingIdValue = document.getElementById('bookingId').value;
                if (!bookingIdValue || !bookingIdValue.startsWith('AFC-')) {
                    throw new Error('Invalid booking ID format');
                }

                // Calculate total units and create service details
                const total = Object.values(serviceQuantities).reduce((sum, qty) => sum + qty, 0);
                if (total === 0) {
                    throw new Error('Mohon pilih minimal 1 layanan');
                }

                // Create service details string
                let serviceDetails = [];
                if (serviceQuantities.cuci > 0) serviceDetails.push(`Cek/Cuci Unit (${serviceQuantities.cuci})`);
                if (serviceQuantities.perbaikan > 0) serviceDetails.push(`Perbaikan Unit (${serviceQuantities.perbaikan})`);
                if (serviceQuantities.pasang > 0) serviceDetails.push(`Pasang Unit Baru (${serviceQuantities.pasang})`);
                
                // Get form data with proper time format
                const waktuValue = document.getElementById('waktuKunjungan').value;
                let waktuText = '';
                let waktuTime = null; // For database TIME column
                if (waktuValue === 'morning') {
                    waktuText = 'Pagi (09:00-11:30)';
                    waktuTime = '09:00:00'; // Valid TIME format for database
                } else if (waktuValue === 'afternoon') {
                    waktuText = 'Siang (13:00-16:00)';
                    waktuTime = '13:00:00'; // Valid TIME format for database
                }

                const formData = {
                    booking_id: bookingIdValue,
                    nama: document.getElementById('nama').value,
                    no_hp: document.getElementById('noHp').value,
                    alamat: document.getElementById('alamat').value,
                    tanggal_kunjungan: document.getElementById('tanggalKunjungan').value,
                    waktu_kunjungan: waktuTime, // Store as TIME format for database
                    jenis_layanan: serviceDetails.join(', '),
                    jumlah_unit: total,
                    catatan: document.getElementById('catatan').value,
                    kode_referral: document.getElementById('kodeReferral').value,
                    status: 'pending',
                    created_at: new Date().toISOString()
                };

                // Validate required fields
                if (!formData.nama || !formData.no_hp || !formData.alamat || !formData.tanggal_kunjungan || !formData.waktu_kunjungan) {
                    throw new Error('Mohon lengkapi semua field yang wajib diisi');
                }

                console.log('Submitting booking:', formData);

                // Save to database
                if (supabaseClient) {
                    const { data, error } = await supabaseClient
                        .from('bookings')
                        .insert([formData])
                        .select();

                    if (error) {
                        throw new Error('Database error: ' + error.message);
                    }

                    console.log('Booking saved to database:', data);
                }
                
                // Send WhatsApp notification
                const serviceDetailsText = serviceDetails.join('\n');
                await sendWhatsAppNotification(
                    formData.nama,
                    formData.no_hp,
                    formData.tanggal_kunjungan,
                    formData.alamat,
                    formData.booking_id,
                    serviceDetailsText,
                    formData.catatan,
                    total,
                    waktuText
                );
                
                // Extract current number from booking ID and generate next ID
                const currentId = bookingIdValue;
                const currentNumber = parseInt(currentId.replace('AFC-', ''));
                const nextId = `AFC-${String(currentNumber + 1).padStart(6, '0')}`;

                console.log('=== BOOKING COMPLETE ===');
                console.log('Current booking ID:', currentId);
                console.log('Next booking ID:', nextId);

                // Reset form and set next booking ID
                bookingForm.reset();
                
                // Set the next booking ID and trigger events to ensure UI updates
                bookingIdInput.value = nextId;
                bookingIdInput.dispatchEvent(new Event('input', { bubbles: true }));
                bookingIdInput.dispatchEvent(new Event('change', { bubbles: true }));
                
                // Reset service quantities
                serviceQuantities = { cuci: 0, perbaikan: 0, pasang: 0 };
                updateServiceDisplay();
                updateSubmitButton();

                // Reset time selection
                morningSlot.classList.remove('selected');
                afternoonSlot.classList.remove('selected');
                waktuKunjunganInput.value = '';

                console.log('Form reset with next ID:', nextId);
                console.log('Booking ID field value after reset:', bookingIdInput.value);

                // Refresh quota
                await fetchDailyQuota();

                // Hide loading and show success
                loadingModal.classList.add('hidden');
                successModal.classList.remove('hidden');

            } catch (error) {
                console.error('Booking error:', error);
                loadingModal.classList.add('hidden');
                errorMessage.textContent = error.message;
                errorModal.classList.remove('hidden');
            }
        });

        // Modal close functions
        function closeSuccessModal() {
            successModal.classList.add('hidden');
        }

        function closeErrorModal() {
            errorModal.classList.add('hidden');
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeBookingId();
            await fetchDailyQuota();
            updateServiceDisplay();
            updateSubmitButton();
            
            // Auto-fill kode referral dari URL parameter
            checkAndFillReferralCode();
        });

        // Function untuk auto-fill kode referral dari URL
        function checkAndFillReferralCode() {
            const kodeReferralInput = document.getElementById('kodeReferral');
            
            // Ambil kode referral dari URL path
            const currentPath = window.location.pathname;
            const pathSegments = currentPath.split('/');
            
            // Cek apakah ada kode di akhir URL (format: /bookingAC/A-0001)
            let referralCode = null;
            
            // Method 1: Dari path segments
            if (pathSegments.length > 0) {
                const lastSegment = pathSegments[pathSegments.length - 1];
                // Cek format kode referral (A-0001, A-0002, dst)
                if (lastSegment && /^A-\d{4}$/.test(lastSegment)) {
                    referralCode = lastSegment;
                }
            }
            
            // Method 2: Dari URL parameters (?ref=A-0001)
            if (!referralCode) {
                const urlParams = new URLSearchParams(window.location.search);
                referralCode = urlParams.get('ref') || urlParams.get('referral') || urlParams.get('code');
                // Validasi format A-0001
                if (referralCode && !/^A-\d{4}$/.test(referralCode)) {
                    referralCode = null;
                }
            }
            
            // Method 3: Dari hash (#A-0001)
            if (!referralCode) {
                const hash = window.location.hash.substring(1);
                if (hash && /^A-\d{4}$/.test(hash)) {
                    referralCode = hash;
                }
            }
            
            console.log('Detected referral code from URL:', referralCode);
            
            if (referralCode) {
                // Auto-fill dan block field
                kodeReferralInput.value = referralCode.toUpperCase();
                kodeReferralInput.readOnly = true;
                kodeReferralInput.disabled = true;
                kodeReferralInput.classList.add('bg-green-50', 'border-green-300', 'text-green-700');
                
                // Update label untuk menunjukkan auto-fill
                const label = document.querySelector('label[for="kodeReferral"]');
                if (label) {
                    label.innerHTML = 'Kode Referral <span class="text-green-600">(Auto-filled dari link)</span>';
                }
                
                // Update placeholder
                kodeReferralInput.placeholder = `Kode referral: ${referralCode}`;
                
                // Tambahkan info text
                const infoText = kodeReferralInput.nextElementSibling;
                if (infoText) {
                    infoText.textContent = `✅ Kode referral ${referralCode} berhasil diterapkan dari link affiliate`;
                    infoText.classList.add('text-green-600');
                }
                
                console.log('Referral code auto-filled and locked:', referralCode);
            } else {
                // Jika tidak ada kode referral, biarkan field optional dan editable
                kodeReferralInput.readOnly = false;
                kodeReferralInput.disabled = false;
                kodeReferralInput.classList.remove('bg-green-50', 'border-green-300', 'text-green-700');
                
                console.log('No referral code detected, field remains optional');
            }
        }
    </script>
</body>
</html>
