<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Booking Service AC - Profesional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary-green: #10b981;
        --secondary-green: #059669;
        --accent-orange: #f97316;
        --light-orange: #fed7aa;
        --soft-white: #ffffff;
        --light-gray: #f8fafc;
        --medium-gray: #e2e8f0;
      }

      body {
        font-family: "Poppins", sans-serif;
        background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 25%, #fef7ed 75%, #ffffff 100%);
        min-height: 100vh;
        position: relative;
        overflow-x: hidden;
      }

      /* Animated Background Elements */
      body::before {
        content: '';
        position: fixed;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle at 25% 25%, rgba(16, 185, 129, 0.1) 0%, transparent 50%),
                    radial-gradient(circle at 75% 75%, rgba(249, 115, 22, 0.08) 0%, transparent 50%);
        animation: floating 20s ease-in-out infinite;
        z-index: -1;
      }

      @keyframes floating {
        0%, 100% { transform: translate(0, 0) rotate(0deg); }
        33% { transform: translate(30px, -30px) rotate(120deg); }
        66% { transform: translate(-20px, 20px) rotate(240deg); }
      }

      /* Decorative circles */
      .bg-decoration {
        position: fixed;
        border-radius: 50%;
        z-index: -1;
        animation: pulse 4s ease-in-out infinite;
      }

      .bg-circle-1 {
        top: 10%;
        right: 10%;
        width: 100px;
        height: 100px;
        background: linear-gradient(45deg, var(--primary-green), var(--accent-orange));
        opacity: 0.1;
        animation-delay: 0s;
      }

      .bg-circle-2 {
        bottom: 20%;
        left: 5%;
        width: 150px;
        height: 150px;
        background: linear-gradient(135deg, var(--accent-orange), var(--primary-green));
        opacity: 0.08;
        animation-delay: 2s;
      }

      .bg-circle-3 {
        top: 50%;
        left: 80%;
        width: 80px;
        height: 80px;
        background: linear-gradient(225deg, var(--primary-green), var(--light-orange));
        opacity: 0.12;
        animation-delay: 1s;
      }

      @keyframes pulse {
        0%, 100% { transform: scale(1) rotate(0deg); opacity: 0.1; }
        50% { transform: scale(1.2) rotate(180deg); opacity: 0.15; }
      }

      /* Ice Effects for Header */
      .ice-header {
        position: relative;
        background-attachment: fixed;
      }

      .ice-crystals {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        overflow: hidden;
      }

      .crystal {
        position: absolute;
        color: rgba(255, 255, 255, 0.8);
        font-size: 1.5rem;
        animation: snowfall 8s linear infinite;
        text-shadow: 0 0 10px rgba(173, 216, 230, 0.8);
      }

      .crystal-1 {
        left: 10%;
        animation-delay: 0s;
        animation-duration: 8s;
      }

      .crystal-2 {
        left: 20%;
        animation-delay: 2s;
        animation-duration: 10s;
        font-size: 1.2rem;
      }

      .crystal-3 {
        left: 40%;
        animation-delay: 4s;
        animation-duration: 12s;
      }

      .crystal-4 {
        left: 60%;
        animation-delay: 1s;
        animation-duration: 9s;
        font-size: 1.8rem;
      }

      .crystal-5 {
        left: 80%;
        animation-delay: 3s;
        animation-duration: 11s;
      }

      .crystal-6 {
        left: 90%;
        animation-delay: 5s;
        animation-duration: 7s;
        font-size: 1.3rem;
      }

      @keyframes snowfall {
        0% {
          transform: translateY(-100px) rotate(0deg);
          opacity: 0;
        }
        10% {
          opacity: 1;
        }
        90% {
          opacity: 1;
        }
        100% {
          transform: translateY(200px) rotate(360deg);
          opacity: 0;
        }
      }

      /* Frost effect on header text */
      .ice-header h1 {
        text-shadow: 0 0 20px rgba(173, 216, 230, 0.8), 0 0 40px rgba(135, 206, 250, 0.6);
        position: relative;
        z-index: 10;
      }

      /* Cool breath effect */
      .ice-header::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 30px;
        background: linear-gradient(to top, rgba(173, 216, 230, 0.3), transparent);
        animation: breathe 3s ease-in-out infinite;
      }

      @keyframes breathe {
        0%, 100% { opacity: 0.3; }
        50% { opacity: 0.7; }
      }
      .form-group {
        position: relative;
        transition: all 0.3s ease;
      }

      .form-group .icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--secondary-green);
        transition: all 0.3s ease;
      }

      .form-group .form-input {
        padding-left: 3rem;
        border: 2px solid var(--medium-gray);
        border-radius: 12px;
        background: var(--soft-white);
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .form-group .form-input:focus {
        border-color: var(--primary-green);
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1), 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
      }

      .form-group:hover .icon {
        color: var(--accent-orange);
        transform: translateY(-50%) scale(1.1);
      }

      /* Enhanced Button Styles */
      .btn-primary {
        background: linear-gradient(135deg, var(--primary-green), var(--secondary-green));
        border: none;
        border-radius: 12px;
        color: white;
        font-weight: 600;
        padding: 12px 24px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        position: relative;
        overflow: hidden;
      }

      .btn-primary::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
      }

      .btn-primary:hover::before {
        left: 100%;
      }

      .btn-secondary {
        background: linear-gradient(135deg, var(--accent-orange), #ea580c);
        border: none;
        border-radius: 12px;
        color: white;
        font-weight: 600;
        padding: 12px 24px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
      }

      .btn-secondary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(249, 115, 22, 0.4);
      }

      /* Price list styles */
      .price-list-toggle {
        transition: all 0.3s ease;
        background: linear-gradient(135deg, var(--soft-white), var(--light-gray));
        border: 2px solid var(--medium-gray);
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .price-list-toggle:hover {
        border-color: var(--primary-green);
        box-shadow: 0 4px 16px rgba(16, 185, 129, 0.2);
        transform: translateY(-2px);
      }

      .price-list-content {
        animation: slideDown 0.3s ease-out;
        background: var(--soft-white);
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .loader {
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .quota-warning {
        background: linear-gradient(135deg, var(--light-orange), var(--accent-orange));
        border: 2px solid var(--accent-orange);
        color: #4a4a4a;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(249, 115, 22, 0.2);
        animation: warningPulse 2s ease-in-out infinite;
      }

      @keyframes warningPulse {
        0%, 100% { box-shadow: 0 4px 12px rgba(249, 115, 22, 0.2); }
        50% { box-shadow: 0 6px 16px rgba(249, 115, 22, 0.4); }
      }

      .quota-full {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
      }

      .quota-available {
        background: linear-gradient(135deg, var(--primary-green), var(--secondary-green));
        color: #1f2937;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        animation: successGlow 3s ease-in-out infinite;
      }

      @keyframes successGlow {
        0%, 100% { box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
        50% { box-shadow: 0 6px 16px rgba(16, 185, 129, 0.5); }
      }

      .info-box {
        transition: all 0.5s ease;
        border-radius: 12px;
        background: var(--soft-white);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .info-box:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      }
      input:read-only {
        background-color: #e9ecef;
        cursor: not-allowed;
        opacity: 0.8;
      }

      /* Enhanced Service section styles */
      .service-section {
        border: 2px solid var(--medium-gray);
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
        background: linear-gradient(135deg, var(--soft-white), var(--light-gray));
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        position: relative;
        overflow: hidden;
      }

      .service-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.05), transparent);
        transition: left 0.5s;
      }

      .service-section:hover {
        border-color: var(--primary-green);
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(16, 185, 129, 0.15);
      }

      .service-section:hover::before {
        left: 100%;
      }

      .service-section.has-selection {
        border-color: var(--primary-green);
        background: linear-gradient(135deg, #f0fdf4, #dcfce7);
        box-shadow: 0 8px 24px rgba(16, 185, 129, 0.2);
        transform: translateY(-2px);
      }

      /* Time slot styles */
      .time-slot {
        border: 2px solid var(--medium-gray);
        border-radius: 12px;
        padding: 16px;
        background: var(--soft-white);
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
      }

      .time-slot::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 0;
        height: 100%;
        background: linear-gradient(135deg, var(--primary-green), var(--accent-orange));
        transition: width 0.3s ease;
        opacity: 0.1;
      }

      .time-slot:hover {
        border-color: var(--primary-green);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(16, 185, 129, 0.2);
      }

      .time-slot:hover::before {
        width: 100%;
      }

      .time-slot.selected {
        border-color: var(--primary-green);
        background: linear-gradient(135deg, #f0fdf4, #dcfce7);
        box-shadow: 0 6px 16px rgba(16, 185, 129, 0.3);
      }

      .time-slot.selected::before {
        width: 100%;
        opacity: 0.2;
      }
      .service-section.disabled {
        opacity: 0.5;
        pointer-events: none;
      }
      .service-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
      }
      .service-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #374151;
      }
      .unit-counter {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 600;
        min-width: 80px;
        text-align: center;
      }

      /* Quantity controls */
      .quantity-controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        margin-top: 1rem;
      }
      .quantity-btn {
        width: 40px;
        height: 40px;
        border: 2px solid #e5e7eb;
        border-radius: 50%;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: bold;
        font-size: 1.2rem;
      }
      .quantity-btn:hover:not(.disabled) {
        border-color: #3b82f6;
        background-color: #eff6ff;
      }
      .quantity-btn.disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .quantity-display {
        font-size: 1.5rem;
        font-weight: bold;
        min-width: 60px;
        text-align: center;
        color: #374151;
      }

      /* Time slot styles */
      .time-option {
        padding: 1rem 1.5rem;
        border: 2px solid #e5e7eb;
        border-radius: 0.75rem;
        cursor: pointer;
        transition: all 0.2s;
        text-align: center;
        font-weight: 600;
        margin-bottom: 0.75rem;
      }
      .time-option:hover:not(.disabled) {
        border-color: #3b82f6;
        background-color: #eff6ff;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .time-option.selected {
        background-color: #3b82f6;
        color: white;
        border-color: #3b82f6;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      }
      .time-option.disabled {
        background-color: #f3f4f6;
        color: #9ca3af;
        cursor: not-allowed;
        border-color: #e5e7eb;
        opacity: 0.6;
      }

      /* Custom cluster input */
      .custom-cluster-input {
        margin-top: 0.75rem;
        display: none;
      }
      .custom-cluster-input.show {
        display: block;
        animation: fadeIn 0.3s ease-in;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Auto refresh indicator */
      .refresh-indicator {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #3b82f6;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.875rem;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      .refresh-indicator.show {
        opacity: 1;
      }
    </style>
  </head>
  <body class="text-gray-700">
    <!-- Animated Background Decorations -->
    <div class="bg-decoration bg-circle-1"></div>
    <div class="bg-decoration bg-circle-2"></div>
    <div class="bg-decoration bg-circle-3"></div>

    <!-- Auto refresh indicator -->
    <div id="refreshIndicator" class="refresh-indicator">
      🔄 Memperbarui data...
    </div>

    <div class="container mx-auto p-4 sm:p-6 md:p-8">
      <div
        class="w-full max-w-2xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden"
      >
        <div
          class="header text-white p-8 text-center relative overflow-hidden ice-header"
          style="background: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('https://images.unsplash.com/photo-1609707042324-730abfaee452?q=80&w=1170&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D') center/cover; opacity: 0.7;"
        >
          <!-- Ice crystals animation -->
          <div class="ice-crystals">
            <div class="crystal crystal-1">❄️</div>
            <div class="crystal crystal-2">❅</div>
            <div class="crystal crystal-3">❄️</div>
            <div class="crystal crystal-4">❅</div>
            <div class="crystal crystal-5">❄️</div>
            <div class="crystal crystal-6">❅</div>
          </div>
          <!-- Frost overlay -->
          <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-b from-blue-100/20 via-transparent to-blue-200/30 pointer-events-none"></div>
          <!-- Header decoration -->
          <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-r from-transparent via-white/10 to-transparent transform -skew-y-1"></div>
          <img
            src="https://i.pinimg.com/736x/b1/43/89/b14389bd28cbf08b8741f7084ce8ec0d.jpg"
            alt="Logo"
            class="w-16 h-16 mx-auto rounded-full mb-4 border-2 border-white shadow-md"
            onerror="this.onerror=null;this.src='https://placehold.co/64x64/e2e8f0/4a5568?text=AFC';"
          />
          <h1 class="text-2xl font-bold tracking-tight relative z-10">Booking Layanan AC</h1>
          <p class="text-gray-300 text-sm mt-2"></p>
        </div>

        <div class="form-container p-8">
          <form id="bookingForm" name="submit-to-google-sheet">
            <div
              id="quotaInfo"
              class="info-box rounded-lg p-4 mb-6 text-center text-sm"
            >
              <p id="quotaMessage">Memuat informasi slot...</p>
              <div id="quotaStatus" class="mt-2 text-xs font-medium">
                Mohon tunggu...
              </div>
            </div>

            <div class="form-group relative mb-4">
              <label for="bookingId" class="block text-sm font-medium mb-1"
                >Booking ID</label
              >
              <span class="icon">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path
                    d="M4 6a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2z"
                  />
                  <path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2" />
                  <path d="M9 12h6" />
                </svg>
              </span>
              <input
                type="text"
                id="bookingId"
                name="bookingId"
                class="form-input w-full p-3 border border-gray-300 rounded-lg"
                readonly
                placeholder="Memuat Booking ID..."
              />
            </div>

            <div class="form-group relative mb-4">
              <label for="nama" class="block text-sm font-medium mb-1"
                >Nama Lengkap</label
              >
              <span class="icon">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                  <circle cx="12" cy="7" r="4"></circle>
                </svg>
              </span>
              <input
                type="text"
                id="nama"
                name="nama"
                class="form-input w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                required
                autocomplete="name"
                placeholder="Masukan nama Anda"
              />
            </div>

            <div class="form-group relative mb-4">
              <label for="noHp" class="block text-sm font-medium mb-1"
                >No WhatsApp</label
              >
              <span class="icon">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path
                    d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
                  ></path>
                </svg>
              </span>
              <input
                type="tel"
                id="noHp"
                name="noHp"
                placeholder="awali dengan angka 62 ( contoh : 62812XXXXXXX)"
                class="form-input w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                required
                autocomplete="tel"
              />
            </div>


            <div class="form-group relative mb-4">
              <label for="alamat" class="block text-sm font-medium mb-1"
                >Alamat Lengkap</label
              >
              <span class="icon">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path
                    d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"
                  ></path>
                  <circle cx="12" cy="10" r="3"></circle>
                </svg>
              </span>
              <textarea
                id="alamat"
                name="alamat"
                rows="3"
                class="form-input w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                required
                autocomplete="street-address"
                placeholder="Contoh :  D4/13 atau alamat lengkap jika eksternal"
              ></textarea>
            </div>

            <div class="form-group mb-4">
              <label
                for="tanggalKunjungan"
                class="block text-sm font-medium mb-1"
                >Tanggal Kunjungan <span class="text-red-500">*</span></label
              >
              <input
                type="date"
                id="tanggalKunjungan"
                name="tanggalKunjungan"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                required
              />
              <p class="text-xs text-gray-500 mt-1">
                ⚠️ Wajib pilih tanggal untuk melihat slot tersedia
              </p>
            </div>

            <!-- Daftar Harga Section -->
            <div class="form-group mb-6">
              <div
                id="priceListToggle"
                class="cursor-pointer bg-blue-50 border border-blue-200 rounded-lg p-4 text-center hover:bg-blue-100 transition"
              >
                <span class="text-blue-700 font-medium"
                  >📋 Klik disini untuk melihat daftar harga</span
                >
              </div>

              <div
                id="priceListContent"
                class="hidden mt-4 bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm"
              >
                <div class="bg-gray-50 p-3 border-b">
                  <h3 class="font-semibold text-gray-800">
                    💰 Daftar Harga Layanan AC
                  </h3>
                </div>
                <div class="p-4">
                  <div class="space-y-2 text-sm">
                    <div
                      class="flex justify-between py-2 border-b border-gray-100"
                    >
                      <span class="text-gray-700">Pemeriksaan Cek</span>
                      <span class="font-medium text-green-600">Gratis</span>
                    </div>
                    <div
                      class="flex justify-between py-2 border-b border-gray-100"
                    >
                      <span class="text-gray-700">Cuci</span>
                      <span class="font-medium text-blue-600">Rp 80.000</span>
                    </div>
                    <div
                      class="flex justify-between py-2 border-b border-gray-100"
                    >
                      <span class="text-gray-700">Bobok Dinding/titik</span>
                      <span class="font-medium text-gray-800">Rp 100.000</span>
                    </div>
                    <div
                      class="flex justify-between py-2 border-b border-gray-100"
                    >
                      <span class="text-gray-700">AC Multi/Unit Indoor</span>
                      <span class="font-medium text-gray-800">Rp 150.000</span>
                    </div>
                    <div
                      class="flex justify-between py-2 border-b border-gray-100"
                    >
                      <span class="text-gray-700">Perbaikan Minor</span>
                      <span class="font-medium text-gray-800">Rp 150.000</span>
                    </div>
                    <div
                      class="flex justify-between py-2 border-b border-gray-100"
                    >
                      <span class="text-gray-700">Bobok Dinding/m'</span>
                      <span class="font-medium text-gray-800">Rp 150.000</span>
                    </div>
                    <div
                      class="flex justify-between py-2 border-b border-gray-100"
                    >
                      <span class="text-gray-700">Bongkar Unit</span>
                      <span class="font-medium text-gray-800">Rp 200.000</span>
                    </div>
                    <div
                      class="flex justify-between py-2 border-b border-gray-100"
                    >
                      <span class="text-gray-700">Pasang Unit</span>
                      <span class="font-medium text-orange-600"
                        >Rp 350.000</span
                      >
                    </div>
                    <div
                      class="flex justify-between py-2 border-b border-gray-100"
                    >
                      <span class="text-gray-700">Perbaikan Mayor</span>
                      <span class="font-medium text-red-600">Rp 400.000</span>
                    </div>
                    <div
                      class="flex justify-between py-2 border-b border-gray-100"
                    >
                      <span class="text-gray-700">Isi Freon</span>
                      <span class="font-medium text-red-600">Rp 400.000</span>
                    </div>
                    <div
                      class="flex justify-between py-2 border-b border-gray-100"
                    >
                      <span class="text-gray-700">Bongkar & Pasang</span>
                      <span class="font-medium text-red-600">Rp 450.000</span>
                    </div>
                    <div class="flex justify-between py-2">
                      <span class="text-gray-700">Overhoul/Cuci Besar</span>
                      <span class="font-medium text-red-700">Rp 465.000</span>
                    </div>
                  </div>


                  <div class="mt-3 pt-3 border-t border-gray-200">
                    <p class="text-xs text-gray-500 text-center">
                      💡 Harga dapat berubah sesuai kondisi lapangan
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Service Selection -->
            <div id="serviceSelection" class="mb-6">
              <label class="block text-sm font-medium mb-4"
                >Pilih Layanan <span class="text-red-500">*</span></label
              >
              <p class="text-xs text-gray-600 mb-4">
                💡 Total maksimal 15 unit AC per hari (gabungan cuci +
                perbaikan)
              </p>

              <!-- Cuci/Pemeriksaan AC Service -->
              <div id="cuciSection" class="service-section">
                <div class="service-header">
                  <h3 class="service-title">🧽 Cek / Cuci Unit</h3>
                  <span
                    id="cuciCount"
                    class="unit-counter bg-blue-100 text-blue-800"
                    >0 unit</span
                  >
                </div>
                <div class="quantity-controls">
                  <button
                    type="button"
                    class="quantity-btn disabled"
                    id="cuciMinus"
                  >
                    −
                  </button>
                  <div class="quantity-display" id="cuciQuantity">0</div>
                  <button type="button" class="quantity-btn" id="cuciPlus">
                    +
                  </button>
                </div>
              </div>

              <!-- Perbaikan Unit Service -->
              <div id="perbaikanSection" class="service-section">
                <div class="service-header">
                  <h3 class="service-title">🔧 Perbaikan Unit</h3>
                  <span
                    id="perbaikanCount"
                    class="unit-counter bg-green-100 text-green-800"
                    >0 unit</span
                  >
                </div>
                <div class="quantity-controls">
                  <button
                    type="button"
                    class="quantity-btn disabled"
                    id="perbaikanMinus"
                  >
                    −
                  </button>
                  <div class="quantity-display" id="perbaikanQuantity">0</div>
                  <button type="button" class="quantity-btn" id="perbaikanPlus">
                    +
                  </button>
                </div>
              </div>

              <!-- Pasang Unit Baru Service -->
              <div id="pemasanganSection" class="service-section">
                <div class="service-header">
                  <h3 class="service-title">🏠 Pasang Unit Baru</h3>
                  <span
                    id="pemasanganCount"
                    class="unit-counter bg-purple-100 text-purple-800"
                    >0 unit</span
                  >
                </div>
                <div class="mb-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                  <p class="text-sm text-blue-800">
                    <span class="font-semibold">📋 Informasi Pemasangan Unit Baru:</span><br>
                    Untuk pemasangan unit baru, teknisi kami akan melakukan survei lokasi untuk menentukan kebutuhan panjang pipa, kabel dan material lainnya sebelum dilakukan pemasangan unit.
                  </p>
                </div>
                <div class="quantity-controls">
                  <button
                    type="button"
                    class="quantity-btn disabled"
                    id="pemasanganMinus"
                  >
                    −
                  </button>
                  <div class="quantity-display" id="pemasanganQuantity">0</div>
                  <button type="button" class="quantity-btn" id="pemasanganPlus">
                    +
                  </button>
                </div>
              </div>

              <!-- Total Units Display -->
              <div class="bg-gray-50 rounded-lg p-4 mt-4">
                <div class="flex justify-between items-center">
                  <span class="font-medium text-gray-700">Total Unit AC:</span>
                  <span
                    id="totalUnitsDisplay"
                    class="font-bold text-lg text-blue-600"
                    >0 / 15</span
                  >
                </div>
              </div>
            </div>

            <!-- Time Selection -->
            <div id="timeSelection" class="mb-6">
              <label class="block text-sm font-medium mb-4"
                >Pilih Waktu Kunjungan
                <span class="text-red-500">*</span></label
              >

              <div
                class="time-option disabled"
                id="morningSlot"
                data-time="morning"
              >
                <div class="font-bold text-lg">🌅 Pagi</div>
                <div class="text-sm text-gray-600 mt-1">08:00 - 11:30</div>
              </div>

              <div
                class="time-option disabled"
                id="afternoonSlot"
                data-time="afternoon"
              >
                <div class="font-bold text-lg">☀️ Siang</div>
                <div class="text-sm text-gray-600 mt-1">13:00 - 16:30</div>
              </div>
            </div>

            <!-- Hidden inputs for form submission -->
            <input
              type="hidden"
              name="selectedServices"
              id="selectedServices"
              value=""
            />
            <input
              type="hidden"
              name="selectedTime"
              id="selectedTime"
              value=""
            />
            <input
              type="hidden"
              name="waktuKunjungan"
              id="waktuKunjungan"
              value=""
            />
            <input type="hidden" name="jumlahUnit" id="jumlahUnit" value="0" />

            <div class="form-group mb-6">
              <label for="catatan" class="block text-sm font-medium mb-1"
                >Catatan Khusus (Opsional)</label
              >
              <textarea
                id="catatan"
                name="catatan"
                rows="3"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                placeholder="Contoh : Saya bersedia reschedule kunjungan teknisi jika ada jadwal kosong lebih cepat"
              ></textarea>
            </div>

            <div class="form-group mb-6">
              <label for="kodeReferral" class="block text-sm font-medium mb-1"
                >Kode Referral (Opsional)</label
              >
              <input
                type="text"
                id="kodeReferral"
                name="kodeReferral"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                placeholder="Masukkan kode referral jika ada"
                maxlength="20"
                style="text-transform: uppercase;"
              />
              <p class="text-xs text-gray-500 mt-1">Kode referral akan otomatis terisi jika Anda mengakses melalui link referral</p>
            </div>

            <button
              type="submit"
              id="submitButton"
              class="btn-primary w-full font-semibold py-3 px-6 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:opacity-50"
              disabled
            >
              Pilih Tanggal Kunjungan
            </button>

            <div
              id="bookingWarning"
              class="hidden mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg"
            >
              <div class="flex items-center">
                <svg
                  class="w-5 h-5 text-yellow-400 mr-2"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    fill-rule="evenodd"
                    d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                    clip-rule="evenodd"
                  ></path>
                </svg>
                <span
                  class="text-yellow-800 text-sm font-medium"
                  id="warningText"
                  >Perhatian!</span
                >
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modals remain the same -->
    <div
      id="loading-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50"
    >
      <div class="bg-white p-8 rounded-xl text-center">
        <div class="loader mx-auto mb-4"></div>
        <p class="text-gray-600">Memproses booking Anda...</p>
        <p class="text-sm text-gray-500 mt-2">
          Mengirim pesan WhatsApp otomatis...
        </p>
      </div>
    </div>

    <div
      id="success-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4"
    >
      <div
        class="bg-white p-8 rounded-xl text-center shadow-2xl max-w-sm w-full"
      >
        <div
          class="w-16 h-16 mx-auto mb-4 bg-green-100 rounded-full flex items-center justify-center text-green-500 text-4xl"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="40"
            height="40"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
        </div>
        <h3 class="text-xl font-bold text-gray-800 mb-2">Booking Berhasil!</h3>
        <p class="text-gray-500 mb-4">
          Jadwal Anda telah kami catat dan pesan konfirmasi telah dikirim ke
          WhatsApp Anda secara otomatis.
        </p>

        <button
          class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition"
          onclick="closeFeedbackMessage()"
        >
          OK
        </button>
      </div>
    </div>

    <div
      id="error-modal"
      class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4"
    >
      <div
        class="bg-white p-8 rounded-xl text-center shadow-2xl max-w-sm w-full"
      >
        <div
          class="w-16 h-16 mx-auto mb-4 bg-red-100 rounded-full flex items-center justify-center text-red-500 text-4xl"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="40"
            height="40"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="15" y1="9" x2="9" y2="15"></line>
            <line x1="9" y1="9" x2="15" y2="15"></line>
          </svg>
        </div>
        <h3 class="text-xl font-bold text-gray-800 mb-2">Terjadi Kesalahan</h3>
        <p id="error-message" class="text-gray-500 mb-4">Silakan coba lagi.</p>

        <button
          class="w-full bg-red-600 text-white p-3 rounded-lg font-semibold hover:bg-red-700 transition"
          onclick="closeErrorModal()"
        >
          OK
        </button>
      </div>
    </div>

    <script>
      // Supabase Configuration
      const SUPABASE_URL = 'https://xjzrrxmrgxuebimvkxhp.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqenJyeG1yZ3h1ZWJpbXZreGhwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MTUwODIsImV4cCI6MjA3MTE5MTA4Mn0.ntXRlLylqiJfA5NbGet1h0977CXPHVCE_G-9OM5R0Wg';
      
      // Initialize Supabase client with error handling
      let supabaseClient = null;
      try {
        if (typeof supabase !== 'undefined' && supabase.createClient) {
          supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          console.log('Supabase client initialized successfully');
        } else {
          console.warn('Supabase library not loaded, using fallback mode');
        }
      } catch (error) {
        console.warn('Failed to initialize Supabase client:', error);
      }

      // Price list toggle functionality
      const priceListToggle = document.getElementById("priceListToggle");
      const priceListContent = document.getElementById("priceListContent");

      priceListToggle.addEventListener("click", function () {
        const isHidden = priceListContent.classList.contains("hidden");

        if (isHidden) {
          priceListContent.classList.remove("hidden");
          priceListToggle.innerHTML =
            '<span class="text-blue-700 font-medium">📋 Tutup daftar harga</span>';
          priceListToggle.classList.add("bg-blue-100");
        } else {
          priceListContent.classList.add("hidden");
          priceListToggle.innerHTML =
            '<span class="text-blue-700 font-medium">📋 Klik disini untuk melihat daftar harga</span>';
          priceListToggle.classList.remove("bg-blue-100");
        }
      });
      document.addEventListener("DOMContentLoaded", function () {
        // ===================================================
        // CONFIGURATION & VARIABLES
        // ===================================================
        // Removed Google Sheets integration, now using Supabase

        // DOM Elements
        const bookingForm = document.forms["submit-to-google-sheet"];
        const submitButton = document.getElementById("submitButton");
        const tanggalKunjunganInput =
          document.getElementById("tanggalKunjungan");
        const bookingIdInput = document.getElementById("bookingId");
        const selectedServicesInput =
          document.getElementById("selectedServices");
        const selectedTimeInput = document.getElementById("selectedTime");
        const waktuKunjunganInput = document.getElementById("waktuKunjungan");
        const jumlahUnitInput = document.getElementById("jumlahUnit");
        const quotaStatus = document.getElementById("quotaStatus");
        const quotaMessage = document.getElementById("quotaMessage");
        const quotaInfo = document.getElementById("quotaInfo");
        const refreshIndicator = document.getElementById("refreshIndicator");
        const totalUnitsDisplay = document.getElementById("totalUnitsDisplay");

        // Note: Cluster elements removed from form

        // Service elements
        const cuciSection = document.getElementById("cuciSection");
        const perbaikanSection = document.getElementById("perbaikanSection");
        const pemasanganSection = document.getElementById("pemasanganSection");
        const cuciCount = document.getElementById("cuciCount");
        const perbaikanCount = document.getElementById("perbaikanCount");
        const pemasanganCount = document.getElementById("pemasanganCount");
        const cuciQuantity = document.getElementById("cuciQuantity");
        const perbaikanQuantity = document.getElementById("perbaikanQuantity");
        const pemasanganQuantity = document.getElementById("pemasanganQuantity");

        // Quantity buttons
        const cuciPlus = document.getElementById("cuciPlus");
        const cuciMinus = document.getElementById("cuciMinus");
        const perbaikanPlus = document.getElementById("perbaikanPlus");
        const perbaikanMinus = document.getElementById("perbaikanMinus");
        const pemasanganPlus = document.getElementById("pemasanganPlus");
        const pemasanganMinus = document.getElementById("pemasanganMinus");

        // Time slots
        const morningSlot = document.getElementById("morningSlot");
        const afternoonSlot = document.getElementById("afternoonSlot");

        // Modals
        const loadingModal = document.getElementById("loading-modal");
        const successModal = document.getElementById("success-modal");
        const errorModal = document.getElementById("error-modal");
        const bookingWarning = document.getElementById("bookingWarning");

        // State management
        let serviceQuantities = {
          cuci: 0,
          perbaikan: 0,
          pemasangan: 0,
        };
        let selectedTime = "";
        let dailyQuota = {}; // Will store daily quota information from server
        let autoRefreshInterval;

        // ===================================================
        // AUTO REFRESH FUNCTIONALITY
        // ===================================================

        function showRefreshIndicator() {
          refreshIndicator.classList.add("show");
          setTimeout(() => {
            refreshIndicator.classList.remove("show");
          }, 2000);
        }

        function startAutoRefresh() {
          // Refresh every 30 seconds
          autoRefreshInterval = setInterval(async () => {
            showRefreshIndicator();
            await fetchInitialData(false); // Silent refresh
            updateDateDisplay();
          }, 30000);
        }

        function stopAutoRefresh() {
          if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
          }
        }

        // ===================================================
        // REMOVED: CLUSTER MANAGEMENT (field removed from form)
        // ===================================================

        // ===================================================
        // QUANTITY MANAGEMENT FUNCTIONS (FIXED LOGIC)
        // ===================================================

        function updateQuantity(serviceType, change) {
          const currentQty = serviceQuantities[serviceType];
          const totalOtherServices = Object.keys(serviceQuantities)
            .filter(key => key !== serviceType)
            .reduce((sum, key) => sum + serviceQuantities[key], 0);

          let newQty = currentQty + change;

          // Ensure quantity doesn't go below 0
          if (newQty < 0) {
            newQty = 0;
          }

          // Ensure total doesn't exceed 15
          const newTotal = newQty + totalOtherServices;
          if (newTotal > 15) {
            newQty = 15 - totalOtherServices; // Adjust to fit within limit
          }

          serviceQuantities[serviceType] = newQty;

          // Update display
          document.getElementById(`${serviceType}Quantity`).textContent = newQty;
          document.getElementById(`${serviceType}Count`).textContent = `${newQty} unit`;

          // Update section styling
          const section = document.getElementById(`${serviceType}Section`);
          section.classList.toggle("has-selection", newQty > 0);

          // Update button states
          updateQuantityButtons();
          updateTotalUnits();
          validateBooking();
        }

        function updateQuantityButtons() {
          const totalUnits = serviceQuantities.cuci + serviceQuantities.perbaikan + serviceQuantities.pemasangan;

          // Update minus buttons
          cuciMinus.classList.toggle("disabled", serviceQuantities.cuci === 0);
          perbaikanMinus.classList.toggle("disabled", serviceQuantities.perbaikan === 0);
          pemasanganMinus.classList.toggle("disabled", serviceQuantities.pemasangan === 0);

          // Update plus buttons - disable if total would exceed 15
          cuciPlus.classList.toggle("disabled", totalUnits >= 15);
          perbaikanPlus.classList.toggle("disabled", totalUnits >= 15);
          pemasanganPlus.classList.toggle("disabled", totalUnits >= 15);
        }

        function updateTotalUnits() {
          const totalUnits = serviceQuantities.cuci + serviceQuantities.perbaikan + serviceQuantities.pemasangan;
          jumlahUnitInput.value = totalUnits;
          totalUnitsDisplay.textContent = `${totalUnits} / 15`;

          // Update color based on total
          if (totalUnits === 0) {
            totalUnitsDisplay.className = "font-bold text-lg text-gray-400";
          } else if (totalUnits >= 8) {
            totalUnitsDisplay.className = "font-bold text-lg text-red-600";
          } else if (totalUnits >= 5) {
            totalUnitsDisplay.className = "font-bold text-lg text-yellow-600";
          } else {
            totalUnitsDisplay.className = "font-bold text-lg text-blue-600";
          }

          // Update hidden input with service data
          const serviceData = {
            cuci: serviceQuantities.cuci,
            perbaikan: serviceQuantities.perbaikan,
            pemasangan: serviceQuantities.pemasangan,
          };
          selectedServicesInput.value = JSON.stringify(serviceData);
        }

        // ===================================================
        // TIME SELECTION FUNCTIONS
        // ===================================================

        function selectTimeSlot(timeSlot) {
          if (timeSlot.classList.contains("disabled")) {
            return;
          }

          // Remove selection from all slots
          morningSlot.classList.remove("selected");
          afternoonSlot.classList.remove("selected");

          // Add selection to clicked slot
          timeSlot.classList.add("selected");
          selectedTime = timeSlot.dataset.time;
          selectedTimeInput.value = selectedTime;

          // Update waktu kunjungan for spreadsheet
          const timeText =
            selectedTime === "morning"
              ? "Pagi (08:00-11:30)"
              : "Siang (13:00-16:30)";
          waktuKunjunganInput.value = timeText;

          validateBooking();
        }

        function enableTimeSlots() {
          morningSlot.classList.remove("disabled");
          afternoonSlot.classList.remove("disabled");
        }

        function disableTimeSlots() {
          morningSlot.classList.add("disabled");
          afternoonSlot.classList.add("disabled");
          morningSlot.classList.remove("selected");
          afternoonSlot.classList.remove("selected");
          selectedTime = "";
          selectedTimeInput.value = "";
          waktuKunjunganInput.value = "";
        }

        // ===================================================
        // VALIDATION FUNCTIONS (ENHANCED)
        // ===================================================

        function validateBooking() {
          const visitDate = tanggalKunjunganInput.value;
          const totalUnits = parseInt(jumlahUnitInput.value) || 0;

          // Reset button state
          submitButton.disabled = true;
          submitButton.classList.add("opacity-50", "cursor-not-allowed");

          if (!visitDate) {
            submitButton.textContent =
              "Pilih Tanggal Kunjungan Terlebih Dahulu";
            disableTimeSlots();
            return;
          }

          // Enable time slots when date is selected
          enableTimeSlots();

          // Check if date is full
          // Di fungsi updateDateDisplay(), pastikan ada validasi seperti ini:
          const quota = dailyQuota[visitDate];
          if (quota) {
            const available = quota.maxCapacity - quota.totalBooked;
            // quota.maxCapacity sudah benar dari server (10 untuk Jumat, 15 untuk hari lain)
          }

          if (totalUnits === 0) {
            submitButton.textContent = "Pilih Minimal 1 Layanan";
            return;
          }

          if (!selectedTime) {
            submitButton.textContent = "Pilih Waktu Kunjungan";
            return;
          }

          // Check if booking would exceed daily capacity
          const currentBooked = quota ? quota.totalBooked : 0;
          if (currentBooked + totalUnits > 15) {
            const available = 15 - currentBooked;
            submitButton.textContent = `Hanya tersisa ${available} slot - Kurangi jumlah unit`;
            showBookingWarning(
              `Tanggal ini hanya tersisa ${available} slot. Silakan kurangi jumlah unit atau pilih tanggal lain.`
            );
            return;
          }

          // All validations passed
          submitButton.disabled = false;
          submitButton.classList.remove("opacity-50", "cursor-not-allowed");
          submitButton.textContent = "Booking Sekarang";
          bookingWarning.classList.add("hidden");
        }

        function showBookingWarning(message) {
          document.getElementById("warningText").textContent = message;
          bookingWarning.classList.remove("hidden");
        }

        // ===================================================
        // DATA FETCHING FUNCTIONS (ENHANCED)
        // ===================================================

        async function fetchInitialData(showLoading = true) {
          if (showLoading) {
            quotaStatus.innerHTML = "Memuat data...";
            bookingIdInput.value = "Memuat...";
          }

          try {
            // Generate next booking ID starting from AFC-250159
            let nextBookingId = 'AFC-250159';
            
            // Try to get the latest booking ID from Supabase to increment
            if (supabaseClient) {
              try {
                const { data: latestBooking } = await supabaseClient
                  .from('bookings')
                  .select('booking_id')
                  .like('booking_id', 'AFC-%')
                  .order('created_at', { ascending: false })
                  .limit(1);
                
                if (latestBooking && latestBooking.length > 0) {
                  const lastId = latestBooking[0].booking_id;
                  const lastNumber = parseInt(lastId.replace('AFC-', ''));
                  if (!isNaN(lastNumber)) {
                    nextBookingId = `AFC-${String(lastNumber + 1).padStart(6, '0')}`;
                  }
                }
              } catch (error) {
                console.warn('Could not fetch latest booking ID, using default:', error);
              }
            }
            
            // Set booking ID immediately
            bookingIdInput.value = nextBookingId;

            // Try to fetch daily quota from Supabase with timeout
            let bookings = null;
            let error = null;

            if (supabaseClient) {
              try {
                const timeoutPromise = new Promise((_, reject) =>
                  setTimeout(() => reject(new Error('Timeout')), 10000)
                );

                const supabasePromise = supabaseClient
                  .from('bookings')
                  .select('tanggal_kunjungan, jumlah_unit')
                  .not('tanggal_kunjungan', 'is', null);

                const result = await Promise.race([
                  supabasePromise,
                  timeoutPromise
                ]);
                
                bookings = result.data;
                error = result.error;
              } catch (err) {
                error = err;
              }
            } else {
              error = new Error('Supabase client not available');
            }

            if (error) {
              console.warn('Supabase error, using fallback:', error);
              // Use fallback - empty quota data
              dailyQuota = {};
            } else {
              // Calculate daily quota
              dailyQuota = {};
              if (bookings && Array.isArray(bookings)) {
                bookings.forEach(booking => {
                  const date = booking.tanggal_kunjungan;
                  if (date) {
                    if (!dailyQuota[date]) {
                      dailyQuota[date] = {
                        totalBooked: 0,
                        maxCapacity: 15 // Default capacity
                      };
                    }
                    dailyQuota[date].totalBooked += booking.jumlah_unit || 0;
                  }
                });
              }
            }

            console.log("Daily quota updated:", dailyQuota);

            // Always update UI regardless of Supabase status
            if (tanggalKunjunganInput.value) {
              updateDateDisplay();
            }

          } catch (error) {
            console.warn("Error fetching data, using fallback:", error);
            
            // Fallback: Generate booking ID starting from AFC-250159
            const nextBookingId = 'AFC-250159';
            
            bookingIdInput.value = nextBookingId;
            
            dailyQuota = {};
            // Set initial status messages
            quotaStatus.innerHTML = "Pilih tanggal untuk melihat slot waktu";
            quotaMessage.innerHTML = "Pilih tanggal kunjungan untuk melihat ketersediaan slot";
            quotaInfo.className = "info-box rounded-lg p-4 mb-6 text-center text-sm";
          }
        }

        function updateDateDisplay() {
          const visitDate = tanggalKunjunganInput.value;
          if (!visitDate) {
            quotaMessage.innerHTML = "Pilih tanggal kunjungan untuk melihat ketersediaan slot";
            quotaMessage.innerHTML =
              "Pilih tanggal kunjungan untuk melihat ketersediaan slot";
            quotaStatus.innerHTML = "Pilih tanggal untuk melihat slot waktu";
            quotaInfo.className =
              "info-box rounded-lg p-4 mb-6 text-center text-sm";
            disableTimeSlots();
            validateBooking();
            return;
          }

          try {
            const dateObj = new Date(visitDate + "T00:00:00");
            const formattedDate = dateObj.toLocaleDateString("id-ID", {
              weekday: "long",
              year: "numeric",
              month: "long",
              day: "numeric",
            });

            // Check quota for this date
            const quota = dailyQuota[visitDate];
            console.log(`Quota for ${visitDate}:`, quota); // Debug log

            if (quota) {
              const available = quota.maxCapacity - quota.totalBooked;

              if (available <= 0) {
                quotaMessage.innerHTML = `Kuota unit terjadwal pada <strong>${formattedDate}: ${quota.totalBooked} / ${quota.maxCapacity} unit</strong>`;
                quotaStatus.innerHTML = "🔴 Jadwal penuh";
                quotaInfo.className =
                  "info-box quota-full rounded-lg p-4 mb-6 text-center text-sm";
                disableTimeSlots();
              } else if (available <= 2) {
                quotaMessage.innerHTML = `Kuota unit terjadwal pada <strong>${formattedDate}: ${quota.totalBooked} / ${quota.maxCapacity} unit</strong>`;
                quotaStatus.innerHTML = `⚠️ Sisa ${available} slot (hampir penuh)`;
                quotaInfo.className =
                  "info-box quota-warning rounded-lg p-4 mb-6 text-center text-sm";
                enableTimeSlots();
              } else {
                quotaMessage.innerHTML = `Kuota unit terjadwal pada <strong>${formattedDate}: ${quota.totalBooked} / ${quota.maxCapacity} unit</strong>`;
                quotaStatus.innerHTML = `✅ Tersedia ${available} slot`;
                quotaInfo.className =
                  "info-box quota-available rounded-lg p-4 mb-6 text-center text-sm";
                enableTimeSlots();
              }
            } else {
              quotaMessage.innerHTML = `Slot waktu tersedia pada <strong>${formattedDate}</strong>`;
              quotaStatus.innerHTML = "✅ Tersedia 15 slot";
              quotaInfo.className =
                "info-box quota-available rounded-lg p-4 mb-6 text-center text-sm";
              enableTimeSlots();
            }
          } catch (e) {
            console.error("Date parsing error:", e);
            quotaMessage.innerHTML = "Error parsing tanggal";
            disableTimeSlots();
          }

          validateBooking();
        }

        // ===================================================
        // EVENT LISTENERS (ENHANCED)
        // ===================================================

        // Quantity button listeners with improved logic
        cuciPlus.addEventListener("click", (e) => {
          e.preventDefault();
          if (!cuciPlus.classList.contains("disabled")) {
            updateQuantity("cuci", 1);
          }
        });

        cuciMinus.addEventListener("click", (e) => {
          e.preventDefault();
          if (!cuciMinus.classList.contains("disabled")) {
            updateQuantity("cuci", -1);
          }
        });

        perbaikanPlus.addEventListener("click", (e) => {
          e.preventDefault();
          if (!perbaikanPlus.classList.contains("disabled")) {
            updateQuantity("perbaikan", 1);
          }
        });

        perbaikanMinus.addEventListener("click", (e) => {
          e.preventDefault();
          if (!perbaikanMinus.classList.contains("disabled")) {
            updateQuantity("perbaikan", -1);
          }
        });

        pemasanganPlus.addEventListener("click", (e) => {
          e.preventDefault();
          if (!pemasanganPlus.classList.contains("disabled")) {
            updateQuantity("pemasangan", 1);
          }
        });

        pemasanganMinus.addEventListener("click", (e) => {
          e.preventDefault();
          if (!pemasanganMinus.classList.contains("disabled")) {
            updateQuantity("pemasangan", -1);
          }
        });

        // Time slot listeners
        morningSlot.addEventListener("click", () =>
          selectTimeSlot(morningSlot)
        );
        afternoonSlot.addEventListener("click", () =>
          selectTimeSlot(afternoonSlot)
        );

        // Indonesian National Holidays 2025 & 2026
        const nationalHolidays = {
          // 2025 - Official Government List
          '2025-01-01': 'Tahun Baru Masehi',
          '2025-01-27': 'Isra Miraj Nabi Muhammad SAW',
          '2025-01-29': 'Tahun Baru Imlek 2576 Kongzili',
          '2025-03-29': 'Hari Raya Nyepi Tahun Baru Saka 1947',
          '2025-03-31': 'Hari Raya Idul Fitri 1446 Hijriah',
          '2025-04-01': 'Hari Raya Idul Fitri 1446 Hijriah',
          '2025-04-18': 'Wafat Yesus Kristus',
          '2025-04-20': 'Kebangkitan Yesus Kristus (Paskah)',
          '2025-05-01': 'Hari Buruh Internasional',
          '2025-05-12': 'Hari Raya Waisak 2569 BE',
          '2025-05-29': 'Kenaikan Yesus Kristus',
          '2025-06-01': 'Hari Lahir Pancasila',
          '2025-06-06': 'Hari Raya Idul Adha 1446 Hijriah',
          '2025-08-17': 'Hari Kemerdekaan Republik Indonesia',
          '2025-09-05': 'Maulid Nabi Muhammad SAW',
          '2025-12-25': 'Hari Raya Natal',
          
          // 2026 - Based on Official Calendar
          '2026-01-01': 'Tahun Baru Masehi',
          '2026-01-16': 'Isra Miraj',
          '2026-02-17': 'Tahun Baru Imlek',
          '2026-03-19': 'Hari Raya Nyepi',
          '2026-03-20': 'Hari Raya Idul Fitri',
          '2026-03-21': 'Hari Raya Idul Fitri',
          '2026-04-03': 'Wafatnya Isa Almasih',
          '2026-05-01': 'Hari Buruh',
          '2026-05-14': 'Kenaikan Isa Almasih',
          '2026-05-27': 'Idul Adha',
          '2026-05-31': 'Hari Waisak',
          '2026-06-01': 'Hari Lahir Pancasila',
          '2026-06-17': 'Tahun Baru Islam',
          '2026-08-17': 'Hari Kemerdekaan Indonesia',
          '2026-08-25': 'Maulid Nabi Muhammad SAW',
          '2026-12-25': 'Hari Natal'
        };

        // Date change listeners with immediate update
        tanggalKunjunganInput.addEventListener("input", function (e) {
          const selectedDateString = e.target.value;

          // Check for Sunday in 2025 and 2026
          if (selectedDateString.startsWith("2025") || selectedDateString.startsWith("2026")) {
            const selectedDate = new Date(selectedDateString + "T00:00:00");
            if (selectedDate.getDay() === 0) {
              // Sunday
              const year = selectedDateString.substring(0, 4);
              alert(
                `Mohon maaf, kami tidak melayani booking pada hari Minggu di tahun ${year}. Silakan pilih hari lain.`
              );
              e.target.value = "";
              updateDateDisplay();
              return;
            }
          }

          // Check for national holidays
          if (nationalHolidays[selectedDateString]) {
            const holidayName = nationalHolidays[selectedDateString];
            alert(
              `Mohon maaf, kami tidak melayani booking pada tanggal merah (${holidayName}). Silakan pilih hari lain.`
            );
            e.target.value = "";
            updateDateDisplay();
            return;
          }

          // Clear time selection when date changes
          selectedTime = "";
          selectedTimeInput.value = "";
          waktuKunjunganInput.value = "";
          morningSlot.classList.remove("selected");
          afternoonSlot.classList.remove("selected");

          updateDateDisplay();
        });

        tanggalKunjunganInput.addEventListener("change", updateDateDisplay);

        // ===================================================
        // FORM SUBMISSION (ENHANCED)
        // ===================================================

        bookingForm.addEventListener("submit", async (e) => {
          e.preventDefault();

          const visitDate = tanggalKunjunganInput.value;
          const totalUnits = parseInt(jumlahUnitInput.value);

          // Enhanced validation before submission
          if (!visitDate) {
            showError("Mohon pilih tanggal kunjungan terlebih dahulu.");
            return;
          }

          if (totalUnits < 1) {
            showError("Mohon pilih minimal 1 layanan.");
            return;
          }

          if (!selectedTime) {
            showError("Mohon pilih waktu kunjungan.");
            return;
          }

          if (!bookingForm.checkValidity()) {
            showError("Mohon lengkapi semua data yang diperlukan.");
            return;
          }

          // Check quota before submission
          const quota = dailyQuota[visitDate];
          const currentBooked = quota ? quota.totalBooked : 0;
          if (currentBooked + totalUnits > 15) {
            const available = 15 - currentBooked;
            showError(
              `Maaf, tanggal ini hanya tersisa ${available} slot. Silakan kurangi jumlah unit atau pilih tanggal lain.`
            );
            return;
          }

          showFeedback("loading");
          submitButton.disabled = true;

          try {
            // Handle cluster data (removed from form, set to empty)
            let clusterValue = "";

            // Prepare selected services for jenis_layanan column
            const selectedServices = [];
            if (serviceQuantities.cuci > 0) {
              selectedServices.push(`Cek/Cuci Unit (${serviceQuantities.cuci})`);
            }
            if (serviceQuantities.perbaikan > 0) {
              selectedServices.push(`Perbaikan Unit (${serviceQuantities.perbaikan})`);
            }
            if (serviceQuantities.pemasangan > 0) {
              selectedServices.push(`Pasang Unit Baru (${serviceQuantities.pemasangan})`);
            }
            
            // Combine services into single string
            const jenisLayanan = selectedServices.join(', ');

            // Prepare booking data for Supabase (using single jenis_layanan column)
            const bookingData = {
              booking_id: document.getElementById("bookingId").value,
              nama: document.getElementById("nama").value,
              no_hp: document.getElementById("noHp").value,
              alamat: document.getElementById("alamat").value,
              cluster: clusterValue,
              tanggal_kunjungan: visitDate,
              waktu_kunjungan: selectedTime === "morning" ? "08:00" : "13:00",
              jenis_layanan: jenisLayanan,
              jumlah_unit: totalUnits,
              catatan: document.getElementById("catatan").value.trim(),
              kode_referral: document.getElementById("kodeReferral").value.trim() || null,
              status: 'pending'
            };

            // Insert booking into Supabase
            if (!supabaseClient) {
              throw new Error('Supabase client tidak tersedia. Silakan refresh halaman.');
            }

            const { data, error } = await supabaseClient
              .from('bookings')
              .insert([bookingData])
              .select();

            if (error) {
              console.error('Supabase error:', error);
              throw new Error('Gagal menyimpan booking ke database: ' + error.message);
            }

            console.log('Booking berhasil disimpan:', data);

            // Send web notification for new booking
            if (window.parent && window.parent.notificationService) {
              try {
                window.parent.notificationService.notifyNewBooking({
                  customer_name: bookingData.nama,
                  tanggal_kunjungan: bookingData.tanggal_kunjungan,
                  jenis_layanan: bookingData.jenis_layanan,
                  alamat: bookingData.alamat
                });
              } catch (notifError) {
                console.error('Error sending booking notification:', notifError);
              }
            }

            // Create service details for WhatsApp message using jenis_layanan
            const timeText =
              selectedTime === "morning"
                ? "Pagi (08:00 - 11:30)"
                : "Siang (13:00 - 16:30)";
            
            const serviceDetails = [
              `Layanan: ${jenisLayanan}`,
              `Waktu: ${timeText}`
            ];

            const notes = document.getElementById("catatan").value.trim();
            await sendWhatsAppMessage(
              document.getElementById("noHp").value,
              document.getElementById("nama").value,
              visitDate,
              totalUnits,
              document.getElementById("alamat").value,
              document.getElementById("bookingId").value,
              serviceDetails.join("\n"),
              clusterValue,
              notes
            );

            // Refresh data after successful booking
            await fetchInitialData(false);
            showFeedback("success");
          } catch (error) {
            console.error("Error!", error.message);
            showError(
              "Terjadi kesalahan saat mengirim data. Silakan coba lagi."
            );
          }
        });

        // ===================================================
        // WHATSAPP INTEGRATION
        // ===================================================

        async function sendWhatsAppMessage(
          phoneNumber,
          customerName,
          visitDate,
          unitCount,
          address,
          bookingId,
          serviceDetails,
          cluster,
          notes
        ) {
          try {
            // Format phone number: handle +62 prefix properly
            let formattedPhone = phoneNumber;
            
            // Remove + sign first
            if (formattedPhone.startsWith('+')) {
              formattedPhone = formattedPhone.substring(1);
            }
            
            // Remove all non-digits
            formattedPhone = formattedPhone.replace(/\D/g, '');
            
            // Format based on starting digits
            if (formattedPhone.startsWith('0')) {
              formattedPhone = '62' + formattedPhone.substring(1);
            } else if (formattedPhone.startsWith('62')) {
              // Already in correct format
              formattedPhone = formattedPhone;
            } else if (!formattedPhone.startsWith('62')) {
              formattedPhone = '62' + formattedPhone;
            }

            const dateObj = new Date(visitDate + "T00:00:00");
            const formattedDate = dateObj.toLocaleDateString("id-ID", {
              weekday: "long",
              year: "numeric",
              month: "long",
              day: "numeric",
            });

            const clusterInfo = cluster ? `\n🏘️ *Lokasi:* ${cluster}` : "";
            const notesInfo = notes ? `\n\n*Catatan:*\n_${notes}_` : "";

            const customerMessage = `📋 KONFIRMASI BOOKING SERVICE AC
            

*Booking ID: ${bookingId}*

Halo Bpk/Ibu *${customerName}*! 👋 

Booking layanan AC Anda telah berhasil dicatat:

📅 *Tanggal Kunjungan:* ${formattedDate}${clusterInfo}
🏠 *Alamat:* ${address}

🛠️ *Detail Layanan:*
${serviceDetails}

*Total Unit AC: ${unitCount} unit*${notesInfo}

✅ Teknisi kami akan melakukan kunjungan sesuai jadwal di atas.

Jika ada pertanyaan atau perlu mengubah jadwal, silakan hubungi kami.

*AQSHA FRESH & COOL*
_Layanan AC Profesional De Latinos & Sekitarnya_`;

            const response = await fetch(
              "https://crm.woo-wa.com/send/message-text",
              {
                method: "POST",
                headers: { 
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  deviceId: "d_ID@6753a3309becd_ZxDLjmEkpsiWQ",
                  number: formattedPhone,
                  message: customerMessage,
                }),
              }
            );

            console.log("WhatsApp API Response:", response.status, response.statusText);
            
            if (response.ok) {
              const result = await response.json();
              console.log("WhatsApp sent successfully:", result);
              return true;
            } else {
              const errorText = await response.text();
              console.error("WhatsApp API Error:", response.status, errorText);
              return false;
            }
          } catch (error) {
            console.error("Error mengirim WhatsApp:", error);
            return false;
          }
        }

        // ===================================================
        // UI HELPER FUNCTIONS
        // ===================================================

        function showFeedback(type) {
          // Hide all modals
          loadingModal.classList.add("hidden");
          successModal.classList.add("hidden");
          errorModal.classList.add("hidden");

          // Show specific modal
          if (type === "loading") loadingModal.classList.remove("hidden");
          else if (type === "success") successModal.classList.remove("hidden");
        }

        function showError(message) {
          document.getElementById("error-message").textContent = message;
          errorModal.classList.remove("hidden");
        }

        window.closeFeedbackMessage = function () {
          showFeedback("close");
          stopAutoRefresh();
          window.location.href = window.location.href.split("?")[0];
        };

        window.closeErrorModal = function () {
          errorModal.classList.add("hidden");
          submitButton.disabled = false;
        };

        function setMinVisitDate() {
          const today = new Date();
          const offset = today.getTimezoneOffset();
          const todayLocal = new Date(today.getTime() - offset * 60 * 1000);
          const todayString = todayLocal.toISOString().split("T")[0];

          tanggalKunjunganInput.min = todayString;

          // Auto-set today's date and immediately update display
          if (!tanggalKunjunganInput.value) {
            tanggalKunjunganInput.value = todayString;
            // Trigger immediate update
            setTimeout(() => {
              updateDateDisplay();
            }, 100);
          }
        }

        // ===================================================
        // REFERRAL CODE HANDLING
        // ===================================================
        
        function initializeReferralCode() {
          const kodeReferralInput = document.getElementById("kodeReferral");
          const urlParams = new URLSearchParams(window.location.search);
          const referralCode = urlParams.get('ref') || urlParams.get('referral');
          
          if (referralCode) {
            // Auto-fill referral code from URL
            kodeReferralInput.value = referralCode.toUpperCase();
            // Make field read-only when auto-filled
            kodeReferralInput.readOnly = true;
            kodeReferralInput.style.backgroundColor = '#f3f4f6';
            kodeReferralInput.style.cursor = 'not-allowed';
            
            // Add visual indicator
            const label = document.querySelector('label[for="kodeReferral"]');
            if (label) {
              label.innerHTML = 'Kode Referral (Terisi Otomatis) <span class="text-green-600">✓</span>';
            }
            
            console.log('Referral code auto-filled:', referralCode);
          } else {
            // Allow manual input when no URL parameter
            kodeReferralInput.addEventListener('input', function(e) {
              e.target.value = e.target.value.toUpperCase();
            });
          }
        }

        // ===================================================
        // PAGE VISIBILITY API FOR AUTO REFRESH
        // ===================================================

        document.addEventListener("visibilitychange", function () {
          if (document.hidden) {
            stopAutoRefresh();
          } else {
            // Page became visible again, refresh data
            fetchInitialData(false);
            startAutoRefresh();
          }
        });

        // ===================================================
        // INITIALIZATION (ENHANCED)
        // ===================================================

        async function initializePage() {
          console.log("Initializing booking system...");

          // Set minimum date and auto-select today
          setMinVisitDate();

          // Initialize referral code handling
          initializeReferralCode();

          // Initialize quantities and buttons
          updateQuantityButtons();
          updateTotalUnits();

          // Fetch initial data
          await fetchInitialData(true);

          // Update display if date is already set
          if (tanggalKunjunganInput.value) {
            updateDateDisplay();
          }

          // Start auto refresh
          startAutoRefresh();

          console.log("Booking system initialized successfully");
        }

        // Initialize the page
        initializePage();

        // Handle page unload
        window.addEventListener("beforeunload", function () {
          stopAutoRefresh();
        });
      });
    </script>
  </body>
</html>
